{% extends 'gestion_medica/layouts/base.html' %}
{% load static %}

{% block titulo_ventana %}Gestión de Medicamentos{% endblock %}

{% block contenido %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-9 col-lg-7">
            <div class="card shadow-lg border-0" style="border-radius: 15px;">
                
                <div class="card-header bg-gradient-info text-white py-3 border-0">
                    <h4 class="mb-0 fs_x_grande font-bold">
                        <i class="fas fa-prescription-bottle-alt me-2"></i>
                        {% if form.instance.pk %}Editar{% else %}Nuevo{% endif %} Medicamento
                    </h4>
                </div>

                <div class="card-body p-4 bg-white">
                    <div class="alert alert-info border-0 bg-info-soft text-info-custom mb-4 rounded-3">
                        <div class="d-flex">
                            <i class="fas fa-search fa-lg me-3 mt-1"></i>
                            <div>
                                <strong>Búsqueda Inteligente:</strong><br>
                                Escriba el nombre (ej: "Paracetamol") para buscar en el catálogo. 
                                Si selecciona uno existente, se sugerirán sus datos base.
                            </div>
                        </div>
                    </div>

                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-12 mb-4">
                                <label for="{{ form.nombre.id_for_label }}" class="form-label fw-bold text-dark">
                                    <i class="fas fa-file-signature me-1"></i> {{ form.nombre.label }}
                                </label>
                                <!-- INPUT DEL NOMBRE CON TOMSELECT -->
                                {{ form.nombre }}
                                
                                {% if form.nombre.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.nombre.errors|striptags }}
                                    </div>
                                {% endif %}
                                <div class="form-text text-muted">
                                    Evite incluir la dosis aquí (ej: use solo "Ibuprofeno").
                                </div>
                            </div>
                        </div>

                        {# 2. DOSIS Y UNIDAD #}
                        <div class="form-group mb-4">
                            <label class="form-label text-muted font-bold fs_normal text-uppercase mb-2">Dosis / Presentación</label>
                            <div class="input-group shadow-sm rounded-pill overflow-hidden border input-group-focus-info">
                                <span class="input-group-text bg-white border-0 text-info-custom ps-4">
                                    <i class="fas fa-flask"></i>
                                </span>
                                {{ form.concentracion }}
                                <!-- SELECT DE UNIDAD (Este se actualizará dinámicamente) -->
                                {{ form.unidad }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-4">
                                <label for="{{ form.clasificacion_riesgo.id_for_label }}" class="form-label fw-bold text-muted small text-uppercase">
                                    {{ form.clasificacion_riesgo.label }}
                                </label>
                                {{ form.clasificacion_riesgo }}
                                {% if form.clasificacion_riesgo.errors %}
                                    <div class="text-danger small">{{ form.clasificacion_riesgo.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-5 border-top pt-4">
                            <a href="{% url 'gestion_medica:ruta_lista_medicamentos' %}" class="btn btn-light border btn-lg px-4">
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg px-5 shadow-sm">
                                <i class="fas fa-save me-2"></i> Guardar Medicamento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estilo para forzar visibilidad del menú por encima de todo -->
<style>
    .ts-dropdown, .ts-dropdown.single { z-index: 9999 !important; }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const inputNombre = document.getElementById('id_nombre');
        const selectUnidad = document.getElementById('id_unidad');

        if (inputNombre) {
            new TomSelect(inputNombre, {
                create: true,           
                createOnBlur: true,     
                persist: false,         
                valueField: 'text',     
                labelField: 'text',     
                searchField: 'text',
                maxItems: 1,
                placeholder: "Buscar o escribir nuevo...",
                dropdownParent: 'body', 
                
                // Conexión a API (Modo Creación)
                load: function(query, callback) {
                    if (query.length < 2) return callback();
                    
                    var url = "{% url 'gestion_medica:api_buscar_medicamentos' %}?modo=creacion&q=" + encodeURIComponent(query);
                    
                    fetch(url)
                        .then(response => response.json())
                        .then(json => {
                            callback(json.items);
                        })
                        .catch(() => {
                            callback();
                        });
                },

                // EVENTO CLAVE: AL SELECCIONAR UN NOMBRE
                onChange: function(value) {
                    // 'this' es la instancia de TomSelect
                    // Buscamos la opción seleccionada en sus datos internos
                    if (value && this.options[value]) {
                        const data = this.options[value];
                        
                        // Si la API nos devolvió una unidad sugerida (del padre)
                        if (data.unidad_sugerida && selectUnidad) {
                            // Cambiamos el valor del select de unidad
                            selectUnidad.value = data.unidad_sugerida;
                            
                            // Efecto visual (destello amarillo) para que el usuario note el cambio
                            selectUnidad.style.transition = "background-color 0.3s";
                            selectUnidad.style.backgroundColor = "#fff3cd"; // Amarillo suave
                            setTimeout(() => {
                                selectUnidad.style.backgroundColor = ""; // Volver a normal
                            }, 1000);
                        }
                    }
                },

                render: {
                    option: function(data, escape) {
                        return `<div class="py-2 px-3">
                                    <i class="fas fa-search text-muted me-2"></i>
                                    <strong>${escape(data.text)}</strong>
                                    ${data.unidad_sugerida ? '<small class="text-muted ms-2">(' + escape(data.unidad_sugerida) + ')</small>' : ''}
                                </div>`;
                    },
                    no_results: function(data, escape) {
                        return '<div class="no-results p-2 text-muted">No encontrado. Presiona Enter para crear <strong>"' + escape(data.input) + '"</strong></div>';
                    },
                    option_create: function(data, escape) {
                        return '<div class="create p-2 text-primary"><i class="fas fa-plus-circle"></i> Crear nuevo: <strong>' + escape(data.input) + '</strong></div>';
                    }
                }
            });
        }
    });
</script>
{% endblock %}