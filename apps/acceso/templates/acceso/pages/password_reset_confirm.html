{% extends 'portal/layouts/base.html' %}
{% load static %}

{% block titulo_ventana %}Establecer Nueva Contraseña{% endblock %}
{% block modulo %}Bomberil{% endblock %}

{% block contenido %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-xl-5 col-lg-6 col-md-8">
      
      <div class="card shadow-sm border-0 rounded-lg">
        <div class="card-body p-5">

          {% if validlink %}
            <h3 class="card-title text-center mb-4 font-bold color_primario">
              <i class="fas fa-lock me-2"></i>Nueva Contraseña
            </h3>
            
            <p class="text-center text-muted mb-4 text-sm">
              Por favor, ingresa tu nueva contraseña segura.
            </p>

            <form method="post" novalidate>
              {% csrf_token %}
              
              {# Errores Globales #}
              {% if form.non_field_errors %}
                <div class="alert alert-danger text-sm mb-4">
                  {{ form.non_field_errors.as_text }}
                </div>
              {% endif %}

              {# 1. NUEVA CONTRASEÑA (Con validación visual) #}
              <div class="mb-3 position-relative password-container">
                <label for="{{ form.new_password1.id_for_label }}" class="form-label font-bold text-sm">
                  {{ form.new_password1.label }}
                </label>
                
                {# Input con wrapper para íconos si usas bomberil_forms (opcional aquí) #}
                <div class="bomberil-input-wrapper">
                    <input 
                      type="password" 
                      name="{{ form.new_password1.name }}" 
                      id="{{ form.new_password1.id_for_label }}" 
                      class="form-control text-base input-new-password" 
                      required 
                      autocomplete="new-password"
                      placeholder="Mínimo 12 caracteres"
                    >
                </div>

                {% if form.new_password1.errors %}
                  <div class="invalid-feedback d-block text-sm">
                    {{ form.new_password1.errors.as_text }}
                  </div>
                {% endif %}

                {# --- CAJA DE REQUISITOS (Feedback en vivo) --- #}
                <div class="password-requirements mt-2 p-3 bg-light rounded border d-none" id="password-feedback-box">
                    <p class="mb-2 font-bold text-muted text-xs text-uppercase">Tu contraseña debe tener:</p>
                    <ul class="list-unstyled mb-0 ps-1 text-sm">
                        <li id="req-length" class="text-muted mb-1"><i class="far fa-circle me-2"></i>Mínimo 12 caracteres</li>
                        <li id="req-upper" class="text-muted mb-1"><i class="far fa-circle me-2"></i>Una mayúscula</li>
                        <li id="req-lower" class="text-muted mb-1"><i class="far fa-circle me-2"></i>Una minúscula</li>
                        <li id="req-number" class="text-muted mb-1"><i class="far fa-circle me-2"></i>Un número</li>
                        <li id="req-symbol" class="text-muted"><i class="far fa-circle me-2"></i>Un símbolo (!@#$%)</li>
                    </ul>
                </div>
              </div>

              {# 2. CONFIRMAR CONTRASEÑA #}
              <div class="mb-4">
                <label for="{{ form.new_password2.id_for_label }}" class="form-label font-bold text-sm">
                  {{ form.new_password2.label }}
                </label>
                
                <input 
                  type="password" 
                  name="{{ form.new_password2.name }}" 
                  id="{{ form.new_password2.id_for_label }}" 
                  class="form-control text-base" 
                  required 
                  autocomplete="new-password"
                  placeholder="Repite la contraseña"
                >

                {% if form.new_password2.errors %}
                  <div class="invalid-feedback d-block text-sm">
                    {{ form.new_password2.errors.as_text }}
                  </div>
                {% endif %}
                
                {# Feedback de coincidencia #}
                <div id="match-feedback" class="text-xs fw-bold mt-1 d-none"></div>
              </div>

              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-primary text-base font-bold py-2">
                  <i class="fas fa-save me-2"></i>Guardar Contraseña
                </button>
              </div>
            </form>

          {% else %}
            {# Enlace Inválido #}
            <div class="text-center py-4">
              <div class="text-danger mb-3">
                <i class="fas fa-exclamation-triangle fa-3x"></i>
              </div>
              <h3 class="card-title text-danger mb-3 font-bold">Enlace Caducado</h3>
              <p class="text-muted text-base mb-4">
                El enlace para restablecer la contraseña no es válido o ya fue utilizado.
              </p>
              <a href="{% url 'acceso:password_reset' %}" class="btn btn-outline-primary text-base">
                Solicitar nuevo enlace
              </a>
            </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
{# Importamos el validador visual que creamos en el paso anterior #}
<script src="{% static 'js/forms/password_validator.js' %}"></script>
{% endblock %}