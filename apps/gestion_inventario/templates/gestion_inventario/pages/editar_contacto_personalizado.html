{% extends "gestion_inventario/layouts/base.html" %}
{% load static %}
{% block titulo_ventana %}Editar Contacto de {{ proveedor.nombre }}{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <form method="POST">
                {% csrf_token %}
                <div class="card shadow-sm">
                    <div class="card-header fondo_secundario_variante">
                        <h4 class="mb-0 text-lg font-bold color_primario">Editar Contacto Personalizado</h4>
                        <p class="mb-0 text-base color_primario_variante">Proveedor: <strong>{{ proveedor.nombre }}</strong></p>
                    </div>
                    <div class="card-body fondo_secundario">
                        
                        <fieldset>
                            <legend class="text-md font-bold color_primario_variante">Datos del Contacto para tu Estación</legend>

                             {% if contacto_form.non_field_errors %}
                                <div class="alert alert-danger text-sm">{{ contacto_form.non_field_errors }}</div>
                            {% endif %}
                            
                            <div class="mb-3">
                                <label for="{{ contacto_form.nombre_contacto.id_for_label }}" class="form-label font-bold text-sm color_primario_variante">{{ contacto_form.nombre_contacto.label }} <span class="text-danger">*</span></label>
                                {{ contacto_form.nombre_contacto }}
                                {% if contacto_form.nombre_contacto.errors %}
                                    <div class="text-danger text-xs mt-1">{{ contacto_form.nombre_contacto.errors|striptags }}</div>
                                {% endif %}
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ contacto_form.telefono.id_for_label }}" class="form-label font-bold text-sm color_primario_variante">{{ contacto_form.telefono.label }}</label>
                                    {{ contacto_form.telefono }}
                                    {% if contacto_form.telefono.errors %}<div class="text-danger text-xs mt-1">{{ contacto_form.telefono.errors|striptags }}</div>{% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ contacto_form.email.id_for_label }}" class="form-label font-bold text-sm color_primario_variante">{{ contacto_form.email.label }}</label>
                                    {{ contacto_form.email }}
                                    {% if contacto_form.email.errors %}<div class="text-danger text-xs mt-1">{{ contacto_form.email.errors|striptags }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ contacto_form.direccion.id_for_label }}" class="form-label font-bold text-sm color_primario_variante">{{ contacto_form.direccion.label }}</label>
                                {{ contacto_form.direccion }}
                                {% if contacto_form.direccion.errors %}<div class="text-danger text-xs mt-1">{{ contacto_form.direccion.errors|striptags }}</div>{% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ contacto_form.region.id_for_label }}" class="form-label font-bold text-sm color_primario_variante">{{ contacto_form.region.label }}</label>
                                    {{ contacto_form.region }}
                                    {% if contacto_form.region.errors %}<div class="text-danger text-xs mt-1">{{ contacto_form.region.errors|striptags }}</div>{% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ contacto_form.comuna.id_for_label }}" class="form-label font-bold text-sm color_primario_variante">{{ contacto_form.comuna.label }}</label>
                                    {{ contacto_form.comuna }}
                                    {% if contacto_form.comuna.errors %}<div class="text-danger text-xs mt-1">{{ contacto_form.comuna.errors|striptags }}</div>{% endif %}
                                </div>
                            </div>
                            
                             <div class="mb-3">
                                <label for="{{ contacto_form.notas.id_for_label }}" class="form-label font-bold text-sm color_primario_variante">{{ contacto_form.notas.label }}</label>
                                {{ contacto_form.notas }}
                                {% if contacto_form.notas.errors %}<div class="text-danger text-xs mt-1">{{ contacto_form.notas.errors|striptags }}</div>{% endif %}
                            </div>

                        </fieldset>

                        <hr>
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'gestion_inventario:ruta_detalle_proveedor' proveedor.pk %}" class="btn btn-secondary text-base">Cancelar</a>
                            
                            {# PERMISO: Gestionar Proveedores (Editar contacto) #}
                            {% if perms.gestion_usuarios.accion_gestion_inventario_gestionar_proveedores %}
                            <button type="submit" class="btn btn-primary text-base">Guardar Cambios</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const regionSelect = document.getElementById('id_region'); 
        const comunaSelect = document.getElementById('id_comuna');   

        if (regionSelect && comunaSelect) {
            // --- Lógica para forzar la carga de comunas si ya hay una región seleccionada ---
            if (regionSelect.value) {
                const selectedComunaId = comunaSelect.value;
                regionSelect.dispatchEvent(new Event('change'));

                if(selectedComunaId) {
                    setTimeout(() => {
                        comunaSelect.value = selectedComunaId;
                    }, 500); 
                }
            }

            const comunasUrlTemplate = "{% url 'api:api_comunas_por_region' 0 %}";

            regionSelect.addEventListener('change', async function() {
                const regionId = this.value;
                const currentComunaValue = comunaSelect.value;
                
                comunaSelect.innerHTML = '<option value="">Seleccione Comuna...</option>'; // Texto legible
                if (!regionId) { return; }

                try {
                    const finalUrl = comunasUrlTemplate.replace('/0/', `/${regionId}/`);
                    const response = await fetch(finalUrl);
                    if (!response.ok) throw new Error('Error al cargar comunas');
                    
                    const comunas = await response.json();
                    
                    comunas.forEach(comuna => {
                        const option = new Option(comuna.nombre, comuna.id);
                        comunaSelect.appendChild(option);
                    });

                    if (comunaSelect.querySelector(`option[value="${currentComunaValue}"]`)) {
                        comunaSelect.value = currentComunaValue;
                    }

                } catch (error) {
                    console.error('Error cargando comunas:', error);
                }
            });
        }
    });
    </script>
{% endblock %}