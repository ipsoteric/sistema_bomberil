{% extends 'gestion_inventario/layouts/base.html' %}
{% load static %}

{% block titulo_ventana %}Recepción de Stock{% endblock %}

{% block titulo_pagina %}
    <span class="fs_grande color_primario">
        <i class="fas fa-dolly-flatbed me-2"></i> Registrar Recepción de Stock
    </span>
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">

<form method="post">
    {% csrf_token %}
    {{ detalle_formset.management_form }}

    <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold fs_mediana">
            <i class="fas fa-info-circle me-1"></i> Datos Generales de la Recepción
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="{{ cabecera_form.proveedor.id_for_label }}" class="form-label fw-bold fs_pequena">{{ cabecera_form.proveedor.label }}</label>
                    {# Aplicamos la clase 'tom-select-basic' para que JS lo inicialice #}
                    <select name="{{ cabecera_form.proveedor.name }}" 
                            id="id_proveedor_select" 
                            class="tom-select-basic fondo_secundario_variante color_primario" 
                            required>
                        <option class="fs_normal fondo_secundario_variante" value="">Seleccione un proveedor...</option>
                        {% for proveedor in cabecera_form.proveedor.field.queryset %}
                        <option class="fs_normal fondo_secundario_variante" value="{{ proveedor.pk }}" {% if cabecera_form.proveedor.value == proveedor.pk %}selected{% endif %}>
                            {{ proveedor.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="{{ cabecera_form.fecha_recepcion.id_for_label }}" class="form-label fw-bold fs_pequena">{{ cabecera_form.fecha_recepcion.label }}</label>
                    {{ cabecera_form.fecha_recepcion }}
                </div>
                <div class="col-md-4">
                    <label for="{{ cabecera_form.notas.id_for_label }}" class="form-label fw-bold fs_pequena">{{ cabecera_form.notas.label }}</label>
                    {{ cabecera_form.notas }}
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold fs_mediana d-flex justify-content-between align-items-center">
            <span>
                <i class="fas fa-boxes me-1"></i> Detalles de los Productos
            </span>
            <button type="button" class="btn btn-sm btn-outline-primary fs_pequena" id="add-detalle-form">
                <i class="fas fa-plus me-1"></i> Agregar Producto
            </button>
        </div>
        <div class="card-body">
            
            <div id="detalle-formset-container">
                {% for form in detalle_formset %}
                <div class="detalle-form mb-3 p-3 border rounded-2 fondo_secundario_variante" id="form-{{ forloop.counter0 }}">
                    <div class="row g-2 align-items-center">
                        <div class="col-lg-2">
                            <label for="{{ form.producto.id_for_label }}" class="form-label fw-bold fs_pequena">Producto</label>
                            {{ form.producto }}
                            {% if form.producto.errors %}<div class="invalid-feedback d-block">{{ form.producto.errors.0 }}</div>{% endif %}
                        </div>

                        <div class="col-lg-2">
                            <label class="form-label fw-bold fs_pequena">Ubicación</label>
                            <select class="form-select fs_normal select-ubicacion-filter">
                                <option value="">Filtrar Ubicación...</option>
                                </select>
                        </div>

                        <div class="col-lg-2">
                            <label for="{{ form.compartimento_destino.id_for_label }}" class="form-label fw-bold fs_pequena">Destino</label>
                            {{ form.compartimento_destino }}
                            {% if form.compartimento_destino.errors %}<div class="invalid-feedback d-block">{{ form.compartimento_destino.errors.0 }}</div>{% endif %}
                        </div>

                        <div class="col-6 col-lg-1">
                            <label for="{{ form.costo_unitario.id_for_label }}" class="form-label fw-bold fs_pequena">Costo U.</label>
                            {{ form.costo_unitario }}
                            {% if form.costo_unitario.errors %}<div class="invalid-feedback d-block">{{ form.costo_unitario.errors.0 }}</div>{% endif %}
                        </div>
                        
                        {# --- MEJORA 1: Divs separados para "N° Serie" y "N° Lote" --- #}
                        <div class="col-6 col-lg-2 div-numero-serie">
                            <label for="{{ form.numero_serie.id_for_label }}" class="form-label fw-bold fs_pequena">N° Serie Fabricante</label>
                            {{ form.numero_serie }}
                            {% if form.numero_serie.errors %}<div class="invalid-feedback d-block">{{ form.numero_serie.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="col-6 col-lg-2 div-numero-lote">
                            <label for="{{ form.numero_lote.id_for_label }}" class="form-label fw-bold fs_pequena">N° Lote Fabricante</label>
                            {{ form.numero_lote }}
                            {% if form.numero_lote.errors %}<div class="invalid-feedback d-block">{{ form.numero_lote.errors.0 }}</div>{% endif %}
                        </div>

                        <div class="col-6 col-lg-1">
                            <label for="{{ form.cantidad.id_for_label }}" class="form-label fw-bold fs_pequena">Cantidad</label>
                            {{ form.cantidad }}
                            {% if form.cantidad.errors %}<div class="invalid-feedback d-block">{{ form.cantidad.errors.0 }}</div>{% endif %}
                        </div>
                        
                        {# --- MEJORA 1 y 2: Divs separados para "Fecha Fabricación" y "Fecha Vencimiento" --- #}
                        <div class="col-6 col-lg-2 div-fecha-fabricacion">
                            <label for="{{ form.fecha_fabricacion.id_for_label }}" class="form-label fw-bold fs_pequena">Fecha Fabricación</label>
                            {{ form.fecha_fabricacion }}
                            {% if form.fecha_fabricacion.errors %}<div class="invalid-feedback d-block">{{ form.fecha_fabricacion.errors.0 }}</div>{% endif %}
                        </div>
                         <div class="col-6 col-lg-2 div-fecha-vencimiento">
                            <label for="{{ form.fecha_vencimiento.id_for_label }}" class="form-label fw-bold fs_pequena">Fecha Vencimiento</label>
                            {{ form.fecha_vencimiento }}
                            {% if form.fecha_vencimiento.errors %}<div class="invalid-feedback d-block">{{ form.fecha_vencimiento.errors.0 }}</div>{% endif %}
                        </div>

                        <div class="col-lg-1 d-flex align-items-end justify-content-center">
                            {% if form.can_delete %}
                                <div class="d-none">{{ form.DELETE }}</div> 
                                
                                <button type="button" 
                                        class="btn btn-sm btn-outline-danger btn-eliminar-fila fs_normal {% if form.prefix == 'detalles-0' %}d-none{% endif %}" 
                                        title="Eliminar esta fila">
                                    <i class="fas fa-trash"></i>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="d-flex justify-content-end mt-4 pt-4 border-top">
                <a href="{% url 'gestion_inventario:ruta_inicio' %}" class="btn btn-secondary fs_normal me-2">Cancelar</a>
                <button type="submit" class="btn btn-primary fs_normal">
                    <i class="fas fa-save me-1"></i> Guardar Recepción
                </button>
            </div>
            
        </div>
    </div>
</form>

</div> <div id="detalle-form-template" class="detalle-form mb-3 p-3 border rounded-2 fondo_secundario_variante d-none">
    <div class="row g-2 align-items-center">
        <div class="col-lg-3">
            <label for="{{ detalle_formset.empty_form.producto.id_for_label }}" class="form-label fw-bold fs_pequena">Producto</label>
            {{ detalle_formset.empty_form.producto }}
        </div>
        <div class="col-lg-2">
            <label for="{{ detalle_formset.empty_form.compartimento_destino.id_for_label }}" class="form-label fw-bold fs_pequena">Destino</label>
            {{ detalle_formset.empty_form.compartimento_destino }}
        </div>
        <div class="col-6 col-lg-1">
            <label for="{{ detalle_formset.empty_form.costo_unitario.id_for_label }}" class="form-label fw-bold fs_pequena">Costo U.</label>
            {{ detalle_formset.empty_form.costo_unitario }}
        </div>

        {# --- MEJORA 1: Divs separados para "N° Serie" y "N° Lote" --- #}
        <div class="col-6 col-lg-2 div-numero-serie">
            <label for="{{ detalle_formset.empty_form.numero_serie.id_for_label }}" class="form-label fw-bold fs_pequena">N° Serie Fab.</label>
            {{ detalle_formset.empty_form.numero_serie }}
        </div>
        <div class="col-6 col-lg-2 div-numero-lote">
            <label for="{{ detalle_formset.empty_form.numero_lote.id_for_label }}" class="form-label fw-bold fs_pequena">N° Lote</label>
            {{ detalle_formset.empty_form.numero_lote }}
        </div>

        <div class="col-6 col-lg-1">
            <label for="{{ detalle_formset.empty_form.cantidad.id_for_label }}" class="form-label fw-bold fs_pequena">Cantidad</label>
            {{ detalle_formset.empty_form.cantidad }}
        </div>

        {# --- MEJORA 1 y 2: Divs separados para "Fecha Fabricación" y "Fecha Vencimiento" --- #}
        <div class="col-6 col-lg-2 div-fecha-fabricacion">
            <label for="{{ detalle_formset.empty_form.fecha_fabricacion.id_for_label }}" class="form-label fw-bold fs_pequena">Fecha Fabricación</label>
            {{ detalle_formset.empty_form.fecha_fabricacion }}
        </div>
        <div class="col-6 col-lg-2 div-fecha-vencimiento">
            <label for="{{ detalle_formset.empty_form.fecha_vencimiento.id_for_label }}" class="form-label fw-bold fs_pequena">Fecha Vencimiento</label>
            {{ detalle_formset.empty_form.fecha_vencimiento }}
        </div>

        <div class="col-lg-1 d-flex align-items-end justify-content-center">
            <div class="d-none">{{ detalle_formset.empty_form.DELETE }}</div>
            
            <button type="button" class="btn btn-sm btn-outline-danger btn-eliminar-fila fs_normal" title="Eliminar esta fila">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}

<script id="product-data" type="application/json">
    {{ product_data_json|safe }}
</script>
<script id="ubicaciones-data" type="application/json">
    {{ ubicaciones_data_json|safe }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- DATOS Y SELECTORES ---
    const productData = JSON.parse(document.getElementById('product-data').textContent);
    const formsetContainer = document.getElementById('detalle-formset-container');
    const addButton = document.getElementById('add-detalle-form');
    const totalFormsInput = document.getElementById('id_detalles-TOTAL_FORMS'); // Prefix 'detalles'
    const ubicacionesData = JSON.parse(document.getElementById('ubicaciones-data').textContent);
    
    const template = document.getElementById('detalle-form-template');
    if (!template) {
        console.error("No se encontró el template del formset.");
        return;
    }

    const tomSelectConfig = {
        create: false,
        sortField: { field: "text", direction: "asc" },
        placeholder: "Buscar..."
    };

    /**
     * MEJORA 3: Función de ayuda para deshabilitar todos los campos de una fila,
     * excepto el selector de producto y el de compartimento.
     */
    function toggleAllFields(formRow, disabled) {
        
        const fields = formRow.querySelectorAll(
            'input[name]:not([name$="-producto"]):not([type="checkbox"]), ' +
            'select[name]:not([name$="-producto"]):not([name$="-compartimento_destino"]), ' +
            'textarea[name]'
        );

        fields.forEach(field => {
            field.disabled = disabled;
            field.classList.toggle('bg-light', disabled); 
        });

        // Ocultar todos los contenedores dinámicos
        if (disabled) {
            formRow.querySelectorAll('.div-numero-serie, .div-numero-lote, .div-fecha-fabricacion, .div-fecha-vencimiento')
                   .forEach(div => div.classList.add('d-none'));
        }
    }


    /**
     * MEJORA 1, 2 y 3: Lógica centralizada para mostrar/ocultar campos
     * según el producto seleccionado.
     */
    function updateFormRowUI(formRow) {
        const productoSelect = formRow.querySelector('select[name$="-producto"]');
        const compartimentoSelect = formRow.querySelector('select[name$="-compartimento_destino"]');
        const selectedProductId = productoSelect.value;
        const producto = productData[selectedProductId];
        
        // --- MEJORA 3: Si no hay producto, deshabilitar todo y salir ---
        if (!producto) {
            toggleAllFields(formRow, true);
            return;
        }

        // Si hay producto, habilitar todos los campos comunes
        toggleAllFields(formRow, false);
        
        // (El resto de esta función es idéntica y ya estaba correcta)

        const esSerializado = producto.es_serializado;
        const esExpirable = producto.es_expirable; 

        const inputCantidad = formRow.querySelector('input[name$="-cantidad"]');
        const divNumSerie = formRow.querySelector('.div-numero-serie');
        const inputNumSerie = formRow.querySelector('input[name$="-numero_serie"]');
        const divNumLote = formRow.querySelector('.div-numero-lote');
        const inputNumLote = formRow.querySelector('input[name$="-numero_lote"]');
        
        const divFechaFab = formRow.querySelector('.div-fecha-fabricacion');
        const inputFechaFab = formRow.querySelector('input[name$="-fecha_fabricacion"]');
        const divFechaVenc = formRow.querySelector('.div-fecha-vencimiento');
        const inputFechaVenc = formRow.querySelector('input[name$="-fecha_vencimiento"]');

        
        if (esSerializado) {
            inputCantidad.value = 1;
            inputCantidad.disabled = true;
            inputCantidad.classList.add('bg-light'); 

            divNumSerie.classList.remove('d-none'); 
            inputNumSerie.disabled = false;
            divNumLote.classList.add('d-none'); 
            inputNumLote.disabled = true;

            divFechaFab.classList.remove('d-none'); 
            inputFechaFab.disabled = false;
            divFechaVenc.classList.add('d-none'); 
            inputFechaVenc.disabled = true;
            inputFechaVenc.value = '';

        } else {
            // Es INSUMO
            if (inputCantidad.value === '1') inputCantidad.value = '';
            inputCantidad.disabled = false;
            inputCantidad.classList.remove('bg-light');

            divNumSerie.classList.add('d-none'); 
            inputNumSerie.disabled = true;
            inputNumSerie.value = '';
            divNumLote.classList.remove('d-none'); 
            inputNumLote.disabled = false;

            divFechaFab.classList.add('d-none'); 
            inputFechaFab.disabled = true;
            inputFechaFab.value = ''; 

            if (esExpirable) {
                divFechaVenc.classList.remove('d-none'); 
                inputFechaVenc.disabled = false;
            } else {
                divFechaVenc.classList.add('d-none'); 
                inputFechaVenc.disabled = true;
                inputFechaVenc.value = '';
            }
        }
    }


    /**
     * Inicializa los listeners y TomSelect para una fila de formulario (existente o nueva)
     */
    function initializeFormRow(formRow) {
        // 1. Configurar el Selector de UBICACIÓN (El Filtro)
        const ubicacionSelect = formRow.querySelector('.select-ubicacion-filter');
        if (ubicacionSelect && ubicacionSelect.options.length <= 1) { // Evitar repoblar si ya tiene datos
            for (const [id, data] of Object.entries(ubicacionesData)) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = data.nombre;
                ubicacionSelect.appendChild(option);
            }
        }

        // 2. Configurar el Selector de COMPARTIMENTO (Destino Real)
        const compartimentoSelect = formRow.querySelector('select[name$=\"-compartimento_destino\"]');
        let tsCompartimento;

        if (compartimentoSelect) {
            // Si ya existe una instancia (ej: al clonar), la destruimos para reconfigurarla limpia
            if (compartimentoSelect.tomselect) {
                // Guardamos el valor seleccionado actual si estamos editando (post fail)
                var initialValue = compartimentoSelect.tomselect.getValue();
                compartimentoSelect.tomselect.destroy();
            }

            // Inicializamos TomSelect vacío o con opciones filtradas
            tsCompartimento = new TomSelect(compartimentoSelect, { 
                ...tomSelectConfig, 
                placeholder: "Seleccione ubicación primero...",
                valueField: 'id',
                labelField: 'nombre',
                searchField: 'nombre',
                options: [], // Iniciamos VACÍO para obligar a usar el filtro
                create: false
            });
            
            // Si Django devolvió el form con error y ya había un valor seleccionado:
            // Debemos intentar restaurar la ubicación y el compartimento visualmente.
            const valorActual = compartimentoSelect.getAttribute('value') || initialValue;
            
            if (valorActual) {
                // Buscamos a qué ubicación pertenece este compartimento
                for (const [ubiId, ubiData] of Object.entries(ubicacionesData)) {
                    const compEncontrado = ubiData.compartimentos.find(c => c.id == valorActual);
                    if (compEncontrado) {
                        ubicacionSelect.value = ubiId; // Seleccionamos la ubicación
                        // Cargamos las opciones de esa ubicación en TomSelect
                        tsCompartimento.addOption(ubiData.compartimentos);
                        tsCompartimento.setValue(valorActual); // Seleccionamos el compartimento
                        tsCompartimento.settings.placeholder = "Seleccione compartimento...";
                        tsCompartimento.inputState(); // Refrescar UI
                        break;
                    }
                }
            } else {
                 tsCompartimento.disable(); // Deshabilitado hasta elegir ubicación
            }
        }

        // 3. Lógica de "Cascada" (Dependencia)
        if (ubicacionSelect && tsCompartimento) {
            ubicacionSelect.addEventListener('change', function() {
                const ubicacionId = this.value;
                
                // Limpiamos el compartimento actual
                tsCompartimento.clear();
                tsCompartimento.clearOptions();

                if (ubicacionId && ubicacionesData[ubicacionId]) {
                    // Habilitamos y cargamos las opciones correspondientes
                    tsCompartimento.enable();
                    tsCompartimento.addOption(ubicacionesData[ubicacionId].compartimentos);
                    tsCompartimento.settings.placeholder = "Seleccione compartimento...";
                } else {
                    // Si seleccionan "Filtrar...", bloqueamos
                    tsCompartimento.disable();
                    tsCompartimento.settings.placeholder = "Seleccione ubicación primero...";
                }
                tsCompartimento.sync(); // Forzar actualización visual
            });
        }
        
        
        // Inicializar TomSelect para el producto
        const productoSelectTS = formRow.querySelector('select[name$=\"-producto\"]');
        if (productoSelectTS && !productoSelectTS.tomselect) {
            new TomSelect(productoSelectTS, { 
                ...tomSelectConfig,
                placeholder: "Buscar producto...",
                onChange: function() {
                    updateFormRowUI(formRow);
                }
            });
        }

        // Ejecutar la lógica de UI al inicializar la fila
        updateFormRowUI(formRow);
    }
    
    /**
     * Clona el template, actualiza los prefijos y lo añade al DOM
     */
    function addForm() {
        const formIndex = parseInt(totalFormsInput.value);
        
        const newFormRow = template.cloneNode(true);
        newFormRow.classList.remove('d-none');
        newFormRow.id = `form-${formIndex}`;
        
        newFormRow.innerHTML = newFormRow.innerHTML.replace(/__prefix__/g, formIndex);
        
        formsetContainer.appendChild(newFormRow);
        
        totalFormsInput.value = formIndex + 1;
        
        initializeFormRow(newFormRow);
    }
    
    // --- INICIALIZACIÓN ---
    
    // 1. Inicializar TomSelect Básico para el proveedor (fuera del formset)
    document.querySelectorAll('.tom-select-basic').forEach(el => {
        if (!el.tomselect) new TomSelect(el, {...tomSelectConfig, placeholder: "Buscar proveedor..."});
    });

    // 2. Inicializar todas las filas existentes en el formset
    formsetContainer.querySelectorAll('.detalle-form').forEach(formRow => {
        initializeFormRow(formRow);
    });

    // 3. Configurar el botón de "Agregar Producto"
    addButton.addEventListener('click', addForm);

    // --- 4. NUEVO: Configurar listeners para los botones de eliminar ---
    // (Usamos delegación de eventos para que funcione en filas nuevas)
    formsetContainer.addEventListener('click', function(e) {
        
        // Buscamos si el clic (o su padre) es un '.btn-eliminar-fila'
        const deleteButton = e.target.closest('.btn-eliminar-fila');
        
        if (deleteButton) {
            e.preventDefault();
            
            const formRow = deleteButton.closest('.detalle-form');
            if (!formRow) return;

            // 1. Encontrar el checkbox DELETE oculto dentro de esta fila
            const deleteCheckbox = formRow.querySelector('input[type="checkbox"][name$="-DELETE"]');
            if (deleteCheckbox) {
                // Marcamos el checkbox para que Django lo procese
                deleteCheckbox.checked = true;
            }

            // 2. Ocultamos la fila de la vista para el usuario
            formRow.classList.add('d-none');
        }
    });

});
</script>

{% endblock %}