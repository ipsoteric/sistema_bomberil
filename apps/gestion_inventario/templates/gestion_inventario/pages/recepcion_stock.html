{% extends 'gestion_inventario/layouts/base.html' %}
{% load static %}

{% block titulo_ventana %}Recepción de Stock{% endblock %}

{% block titulo_pagina %}
    <span class="fs_grande color_primario">
        <i class="fas fa-dolly-flatbed me-2"></i> Registrar Recepción de Stock
    </span>
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">

<form method="post">
    {% csrf_token %}

    <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold fs_mediana">
            <i class="fas fa-info-circle me-1"></i> Datos Generales de la Recepción
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="{{ cabecera_form.proveedor.id_for_label }}" class="form-label fw-bold fs_pequena">{{ cabecera_form.proveedor.label }}</label>
                    <select name="{{ cabecera_form.proveedor.name }}" 
                            id="id_proveedor_select" 
                            class="form-select form-select-sm fs_normal" 
                            required>
                        {# Tom Select usará este como placeholder si se configura #}
                        <option class="fs_normal" value="">Seleccione un proveedor...</option>
                        {% for value, text in cabecera_form.proveedor.field.choices %}
                            {% if value %} {# Evita el option vacío por defecto de Django #}
                            <option value="{{ value }}" {% if cabecera_form.proveedor.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ text }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    {% if cabecera_form.proveedor.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in cabecera_form.proveedor.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <label for="{{ cabecera_form.fecha_recepcion.id_for_label }}" class="form-label fw-bold fs_pequena">{{ cabecera_form.fecha_recepcion.label }}</label>
                    {{ cabecera_form.fecha_recepcion }}
                    {% if cabecera_form.fecha_recepcion.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in cabecera_form.fecha_recepcion.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-5">
                    <label for="{{ cabecera_form.notas.id_for_label }}" class="form-label fw-bold fs_pequena">{{ cabecera_form.notas.label }}</label>
                    {{ cabecera_form.notas }}
                    {% if cabecera_form.notas.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in cabecera_form.notas.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold fs_mediana">
            <i class="fas fa-boxes me-1"></i> Artículos Recibidos
        </div>
        <div class="card-body">
            {{ detalle_formset.management_form }}
            
            <div id="detalle-formset-container">
                {% for form in detalle_formset %}
                <div class="detalle-form border-bottom pb-3 mb-3 {% if forloop.first %}pt-0{% else %}pt-3{% endif %}">
                    {{ form.id }} {# Campo oculto con el ID si editas #}
                    <div class="row g-2 align-items-start">
                        <div class="col-md-3">
                            <label for="{{ form.producto.id_for_label }}" class="form-label fw-bold fs_pequena">{{ form.producto.label }}</label>
                            {{ form.producto }}
                            {% if form.producto.errors %}<div class="invalid-feedback d-block">{% for error in form.producto.errors %}{{ error }}{% endfor %}</div>{% endif %}
                            <input type="hidden" class="es-serializado-flag" 
                                    value="{{ form.instance.producto.es_serializado|default:'false'|lower }}">
                        </div>
                        <div class="col-md-2">
                            <label for="{{ form.compartimento_destino.id_for_label }}" class="form-label fw-bold fs_pequena">{{ form.compartimento_destino.label }}</label>
                            {{ form.compartimento_destino }} {# Este select será mejorado por TomSelect #}
                            {% if form.compartimento_destino.errors %}<div class="invalid-feedback d-block">{% for error in form.compartimento_destino.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>
                        
                        <div class="col-md-1">
                            <label for="{{ form.costo_unitario.id_for_label }}" class="form-label fw-bold fs_pequena">{{ form.costo_unitario.label }}</label>
                            {{ form.costo_unitario }}
                            {% if form.costo_unitario.errors %}<div class="invalid-feedback d-block">{% for error in form.costo_unitario.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="col-md-1 insumo-fields">
                            <label for="{{ form.cantidad.id_for_label }}" class="form-label fw-bold fs_pequena">{{ form.cantidad.label }}</label>
                            {{ form.cantidad }}
                            {% if form.cantidad.errors %}<div class="invalid-feedback d-block">{% for error in form.cantidad.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>
                        <div class="col-md-2 insumo-fields">
                            <label for="{{ form.numero_lote.id_for_label }}" class="form-label fw-bold fs_pequena">{{ form.numero_lote.label }}</label>
                            {{ form.numero_lote }}
                            {% if form.numero_lote.errors %}<div class="invalid-feedback d-block">{% for error in form.numero_lote.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>
                        <div class="col-md-2 insumo-fields">
                            <label for="{{ form.fecha_vencimiento.id_for_label }}" class="form-label fw-bold fs_pequena">{{ form.fecha_vencimiento.label }}</label>
                            {{ form.fecha_vencimiento }}
                            {% if form.fecha_vencimiento.errors %}<div class="invalid-feedback d-block">{% for error in form.fecha_vencimiento.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>
                        
                        <div class="col-md-2 activo-fields" style="display: none;">
                            <label for="{{ form.numero_serie.id_for_label }}" class="form-label fw-bold fs_pequena">{{ form.numero_serie.label }}</label>
                            {{ form.numero_serie }}
                            {% if form.numero_serie.errors %}<div class="invalid-feedback d-block">{% for error in form.numero_serie.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>
                        <div class="col-md-2 activo-fields" style="display: none;">
                            <label for="{{ form.fecha_fabricacion.id_for_label }}" class="form-label fw-bold fs_pequena">{{ form.fecha_fabricacion.label }}</label>
                            {{ form.fecha_fabricacion }}
                            {% if form.fecha_fabricacion.errors %}<div class="invalid-feedback d-block">{% for error in form.fecha_fabricacion.errors %}{{ error }}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="col-md-1 d-flex align-items-end">
                            {% if form.can_delete %}
                                <div class="form-check mb-2">
                                    {{ form.DELETE }}
                                    <label class="form-check-label text-danger fs_pequena" for="{{ form.DELETE.id_for_label }}">Eliminar</label>
                                </div>
                            {% endif %}
                        </div>
                    </div>{% if form.non_field_errors %}
                        <div class="alert alert-danger mt-2 p-1 fs_pequena">
                            {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>{% endfor %}
            </div>

            <div id="empty-form" class="detalle-form border-bottom pb-3 mb-3 pt-3" style="display: none;">
                {{ detalle_formset.empty_form.id }}
                <div class="row g-2 align-items-start">
                    <div class="col-md-3">
                        <label for="{{ detalle_formset.empty_form.producto.id_for_label }}" class="form-label fw-bold fs_pequena">{{ detalle_formset.empty_form.producto.label }}</label>
                        {{ detalle_formset.empty_form.producto }}
                        <input type="hidden" class="es-serializado-flag" value="false">
                    </div>
                    <div class="col-md-2">
                        <label for="{{ detalle_formset.empty_form.compartimento_destino.id_for_label }}" class="form-label fw-bold fs_pequena">{{ detalle_formset.empty_form.compartimento_destino.label }}</label>
                        {{ detalle_formset.empty_form.compartimento_destino }}
                    </div>
                    <div class="col-md-1">
                        <label for="{{ detalle_formset.empty_form.costo_unitario.id_for_label }}" class="form-label fw-bold fs_pequena">{{ detalle_formset.empty_form.costo_unitario.label }}</label>
                        {{ detalle_formset.empty_form.costo_unitario }}
                    </div>
                    <div class="col-md-1 insumo-fields">
                        <label for="{{ detalle_formset.empty_form.cantidad.id_for_label }}" class="form-label fw-bold fs_pequena">{{ detalle_formset.empty_form.cantidad.label }}</label>
                        {{ detalle_formset.empty_form.cantidad }}
                    </div>
                    <div class="col-md-2 insumo-fields">
                        <label for="{{ detalle_formset.empty_form.numero_lote.id_for_label }}" class="form-label fw-bold fs_pequena">{{ detalle_formset.empty_form.numero_lote.label }}</label>
                        {{ detalle_formset.empty_form.numero_lote }}
                    </div>
                    <div class="col-md-2 insumo-fields">
                        <label for="{{ detalle_formset.empty_form.fecha_vencimiento.id_for_label }}" class="form-label fw-bold fs_pequena">{{ detalle_formset.empty_form.fecha_vencimiento.label }}</label>
                        {{ detalle_formset.empty_form.fecha_vencimiento }}
                    </div>

                    <div class="col-md-2 activo-fields" style="display: none;">
                        <label for="{{ detalle_formset.empty_form.numero_serie.id_for_label }}" class="form-label fw-bold fs_pequena">{{ detalle_formset.empty_form.numero_serie.label }}</label>
                        {{ detalle_formset.empty_form.numero_serie }}
                    </div>
                    <div class="col-md-2 activo-fields" style="display: none;">
                        <label for="{{ detalle_formset.empty_form.fecha_fabricacion.id_for_label }}" class="form-label fw-bold fs_pequena">{{ detalle_formset.empty_form.fecha_fabricacion.label }}</label>
                        {{ detalle_formset.empty_form.fecha_fabricacion }}
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        {% if detalle_formset.empty_form.can_delete %}
                            <div class="form-check mb-2">
                                {{ detalle_formset.empty_form.DELETE }}
                                <label class="form-check-label text-danger fs_pequena" for="{{ detalle_formset.empty_form.DELETE.id_for_label }}">Eliminar</label>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <button type="button" id="add-form" class="btn btn-outline-success btn-sm mt-2 fs_normal">
                <i class="fas fa-plus me-1"></i> Añadir otro artículo
            </button>
        </div>
    </div>

    <div class="text-end mb-4">
        <a href="{% url 'gestion_inventario:ruta_stock_actual' %}" class="btn btn-secondary fs_normal">Cancelar</a>
        <button type="submit" class="btn btn-primary fs_normal">
            <i class="fas fa-save me-1"></i> Guardar Recepción
        </button>
    </div>

</form>

</div>
{% endblock %}


{% block scripts %}
{{ block.super }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Función para mostrar/ocultar campos Activo/Insumo (SIN CAMBIOS)
    function toggleFields(formRow) {
        const productoSelect = formRow.querySelector('.producto-select');
        const selectedOption = productoSelect.options[productoSelect.selectedIndex];
        const esSerializadoFlagInput = formRow.querySelector('.es-serializado-flag');
        
        let esSerializado = false;
        if (selectedOption && selectedOption.dataset.esSerializado) {
            esSerializado = selectedOption.dataset.esSerializado === 'true';
            if(esSerializadoFlagInput) esSerializadoFlagInput.value = esSerializado;
        } else if (esSerializadoFlagInput) {
            esSerializado = esSerializadoFlagInput.value === 'true';
        }

        const insumoFields = formRow.querySelectorAll('.insumo-fields');
        const activoFields = formRow.querySelectorAll('.activo-fields');

        insumoFields.forEach(el => el.style.display = esSerializado ? 'none' : '');
        activoFields.forEach(el => el.style.display = esSerializado ? '' : 'none');

        const insumoInputs = formRow.querySelectorAll('.insumo-field');
        const activoInputs = formRow.querySelectorAll('.activo-field');
        insumoInputs.forEach(input => input.disabled = esSerializado);
        activoInputs.forEach(input => input.disabled = !esSerializado);
        
        const cantidadInput = formRow.querySelector('input[name$="-cantidad"]');
        if(cantidadInput){
            if (esSerializado) {
                cantidadInput.value = 1;
                cantidadInput.readOnly = true;
                cantidadInput.closest('.insumo-fields').style.display = ''; 
            } else {
                cantidadInput.readOnly = false;
            }
        }
    }

    // --- Añadir data-attribute a las opciones del select de producto (SIN CAMBIOS) ---
    // Esta función debe procesar también el template #empty-form
    function addDataAttributesToSelects() {
        document.querySelectorAll('.detalle-form .producto-select').forEach(select => {
            if (!select.options[1] || !select.options[1].hasAttribute('data-es-serializado')) {
                Array.from(select.options).forEach(option => {
                    if (option.value) {
                        // ... (Tu lógica actual para data-es-serializado) ...
                        const textoOpcion = option.textContent.toLowerCase();
                        option.dataset.esSerializado = textoOpcion.includes('casco') || textoOpcion.includes('era') ? 'true' : 'false';
                    }
                });
            }
            const formRow = select.closest('.detalle-form');
            if(formRow && formRow.id !== 'empty-form') { // No ocultar campos en el template
                 toggleFields(formRow);
            }
        });
    }
    
    // --- Lógica para añadir formularios del FormSet (CORREGIDA) ---
    const container = document.getElementById('detalle-formset-container');
    const addButton = document.getElementById('add-form');
    // 1. Obtener el NODO de la plantilla
    const emptyFormNode = document.getElementById('empty-form'); 
    
    let formNum = {{ detalle_formset.total_form_count }}; // Contador inicial
    
    addButton.addEventListener('click', function() {
        // 2. Clonar el NODO completo (con su wrapper <div>)
        const newFormRow = emptyFormNode.cloneNode(true);

        // 3. Quitar ID y hacerlo visible
        newFormRow.removeAttribute('id');
        newFormRow.style.display = ''; // El original está 'display: none'

        // 4. Reemplazar el prefijo en todo el HTML interno del clon
        // Esto actualiza los name="", id="", for="" de los inputs y labels
        newFormRow.innerHTML = newFormRow.innerHTML.replace(/__prefix__/g, formNum);
        
        // 5. Añadir el nuevo NODO (la fila completa) al contenedor
        container.appendChild(newFormRow);
        
        // 6. Actualizar el contador total en el management form
        document.getElementById('id_{{ detalle_formset.prefix }}-TOTAL_FORMS').value = ++formNum;

        // 7. Re-inicializar listeners (TomSelect, producto-change) PARA ESTA NUEVA FILA
        addEventListenersToForm(newFormRow);
        
        // 8. Ejecutar el toggleFields para la nueva fila (basado en el producto por defecto)
        toggleFields(newFormRow);
    });
    // --- FIN DE LA CORRECCIÓN ---

    const proveedorSelect = document.getElementById('id_proveedor_select');
    if (proveedorSelect && window.TomSelect) {
        new TomSelect(proveedorSelect,{
            create: false, 
            sortField: { field: "text", direction: "asc" },
            placeholder: 'Buscar o seleccionar proveedor...',
             // Añadimos render para compatibilidad con modo oscuro si es necesario
             render: {
                 option: function(data, escape) {
                     return `<div class="option">${escape(data.text)}</div>`;
                 },
                 item: function(data, escape) {
                    return `<div class="item">${escape(data.text)}</div>`;
                 }
                 // Puedes añadir más renderizadores si los necesitas
             }
        });
    }


    // --- Lógica para el cambio en el select de Producto y TOM SELECT (SIN CAMBIOS) ---
    function addEventListenersToForm(formRow) {
        // Listener para el select de Producto
        const productoSelect = formRow.querySelector('.producto-select');
        if (productoSelect) {
            productoSelect.addEventListener('change', function() {
                toggleFields(formRow);
            });
        }

        // Inicializar Tom Select para el destino
        const compartimentoSelect = formRow.querySelector('select[name$="-compartimento_destino"]');
        if (compartimentoSelect && !compartimentoSelect.tomselect) {
            new TomSelect(compartimentoSelect, {
                create: false,
                sortField: { field: "text", direction: "asc" },
                placeholder: "Buscar destino (Ej: Cabina, Bodega...)"
            });
        }
        
        // (Opcional) Inicializar TomSelect para el producto también
        const productoSelectTS = formRow.querySelector('select[name$="-producto"]');
        if (productoSelectTS && !productoSelectTS.tomselect) {
            new TomSelect(productoSelectTS, {
                create: false,
                sortField: { field: "text", direction: "asc" },
                placeholder: "Buscar producto..."
            });
        }
    }
    
    // --- Inicialización ---
    // 1. Añadir data-attributes a todos los selects (existentes + el template)
    addDataAttributesToSelects(); 
    
    // 2. Añadir listeners (TomSelect, change) a los forms ya existentes
    document.querySelectorAll('#detalle-formset-container .detalle-form').forEach(formRow => {
        addEventListenersToForm(formRow); 
        // 3. Asegurar estado inicial correcto (no es necesario, addDataAttributesToSelects ya lo hace)
        // toggleFields(formRow); 
    });

});
</script>
{% endblock %}