{% extends "gestion_inventario/layouts/base.html" %}
{% load static %}
{% block titulo_ventana %}Editar {{ producto.producto_global.nombre_oficial }}{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header fondo_secundario_variante">
                    <h4 class="mb-0 fs_grande color_primario">Editar Producto Local</h4>
                    <small class="color_primario_muteado fs_pequena">Estás editando cómo gestiona "{{ estacion.nombre }}" el producto:</small>
                    <h5 class="mb-0 color_primario_variante fs_normal">{{ producto.producto_global.nombre_oficial }}</h5>
                </div>
                <div class="card-body fondo_secundario">
                    <p class="color_primario_muteado fs_normal">
                        Modifica los detalles de gestión interna para este producto en tu estación.
                    </p>
                    <hr>
                    
                    <form method="POST">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.sku.id_for_label }}" class="form-label fs_normal color_primario_variante">{{ form.sku.label }}</label>
                            {{ form.sku }}
                            <small class="form-text color_primario_muteado fs_pequena">{{ form.sku.help_text }}</small>
                            {% if form.sku.errors %}
                                <div class="text-danger fs_pequena mt-1">{{ form.sku.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.es_serializado }}
                                <label class="form-check-label fs_normal color_primario_variante" for="{{ form.es_serializado.id_for_label }}">
                                    {{ form.es_serializado.label }}
                                </label>
                            </div>
                            <small class="form-text color_primario_muteado fs_pequena">{{ form.es_serializado.help_text }}</small>
                             {% if form.es_serializado.errors %}
                                <div class="text-danger fs_pequena mt-1">{{ form.es_serializado.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                             <div class="form-check form-switch">
                                 {{ form.es_expirable }}
                                 <label class="form-check-label fs_normal color_primario_variante" for="{{ form.es_expirable.id_for_label }}">
                                     {{ form.es_expirable.label }}
                                 </label>
                            </div>
                             <small class="form-text color_primario_muteado fs_pequena">{{ form.es_expirable.help_text }}</small>
                            {% if form.es_expirable.errors %}
                                <div class="text-danger fs_pequena mt-1">{{ form.es_expirable.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.proveedor_preferido.id_for_label }}" class="form-label fs_normal color_primario_variante">{{ form.proveedor_preferido.label }}</label>
                            {{ form.proveedor_preferido }}
                            {% if form.proveedor_preferido.errors %}
                                <div class="text-danger fs_pequena mt-1">{{ form.proveedor_preferido.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.costo_compra.id_for_label }}" class="form-label fs_normal color_primario_variante">{{ form.costo_compra.label }}</label>
                             <div class="input-group">
                                 <span class="input-group-text">$</span>
                                 {{ form.costo_compra }}
                             </div>
                            {% if form.costo_compra.errors %}
                                <div class="text-danger fs_pequena mt-1">{{ form.costo_compra.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.vida_util_estacion_anos.id_for_label }}" class="form-label fs_normal color_primario_variante">Vida Útil (Años) - Regla Local</Mabel>
                            {{ form.vida_util_estacion_anos }}
                            <small class="form-text color_primario_muteado fs_pequena">
                                Define la vida útil que usará tu estación. 
                                Si se deja en blanco, se usará la recomendación global ({{ producto.producto_global.vida_util_recomendada_anos|default:"N/A" }} años).
                            </small>
                            {% if form.vida_util_estacion_anos.errors %}
                                <div class="text-danger fs_pequena mt-1">{{ form.vida_util_estacion_anos.errors|striptags }}</div>
                            {% endif %}
                        </div>
                        <hr>
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'gestion_inventario:ruta_catalogo_local' %}" class="btn btn-secondary fs_normal">Cancelar</a>
                            <button type="submit" class="btn btn-primary fs_normal">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // Configuración de TomSelect en modo "Solo Selección"
        const tomSelectConfig = {
            create: false,
            sortField: { field: "text", direction: "asc" },
            placeholder: "Buscar proveedor...",
            allowEmptyOption: true,
        };

        // Inicializar todos los selects que tengan la clase 'tom-select-basic'
        document.querySelectorAll('.tom-select-basic').forEach(el => {
            // Evitamos reinicializar si ya tiene instancia
            if (!el.tomselect) {
                new TomSelect(el, tomSelectConfig);
            }
        });
    });
</script>
{% endblock %}