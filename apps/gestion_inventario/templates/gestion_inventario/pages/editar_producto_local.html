{% extends "gestion_inventario/layouts/base.html" %}
{% load static %}
{% block titulo_ventana %}Editar {{ producto.producto_global.nombre_oficial }}{% endblock %}

{% block titulo_pagina %}
    <span class="text-xl color_primario">
        <i class="fas fa-edit me-2"></i> Editar Producto Local
    </span>
{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom py-3">
                    <h4 class="mb-1 text-xl font-bold color_primario">Editar Configuración</h4>
                    <div class="text-sm text-muted">
                        Estás editando cómo gestiona "<strong>{{ estacion.nombre }}</strong>" el producto:
                    </div>
                    <h5 class="mb-0 text-lg font-bold color_primario_variante mt-2">
                        {{ producto.producto_global.nombre_oficial }}
                    </h5>
                </div>
                <div class="card-body p-4">
                    <p class="text-base text-muted mb-4">
                        Modifica los detalles de gestión interna para este producto en tu estación (SKU, costos, alertas).
                    </p>
                    
                    <form method="POST">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger text-sm">
                                {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.sku.id_for_label }}" class="form-label font-bold text-sm color_primario_variante">{{ form.sku.label }}</label>
                            {{ form.sku }}
                            <div class="form-text text-xs text-muted">{{ form.sku.help_text }}</div>
                            {% if form.sku.errors %}
                                <div class="text-danger text-xs mt-1">{{ form.sku.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.es_serializado }}
                                <label class="form-check-label text-base color_primario_variante" for="{{ form.es_serializado.id_for_label }}">
                                    {{ form.es_serializado.label }}
                                </label>
                            </div>
                            <div class="form-text text-xs text-muted ms-4">{{ form.es_serializado.help_text }}</div>
                             {% if form.es_serializado.errors %}
                                <div class="text-danger text-xs mt-1 ms-4">{{ form.es_serializado.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                             <div class="form-check form-switch">
                                 {{ form.es_expirable }}
                                 <label class="form-check-label text-base color_primario_variante" for="{{ form.es_expirable.id_for_label }}">
                                     {{ form.es_expirable.label }}
                                 </label>
                            </div>
                             <div class="form-text text-xs text-muted ms-4">{{ form.es_expirable.help_text }}</div>
                            {% if form.es_expirable.errors %}
                                <div class="text-danger text-xs mt-1 ms-4">{{ form.es_expirable.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.stock_critico.id_for_label }}" class="form-label text-sm color_primario_variante text-danger font-bold">
                                <i class="fas fa-exclamation-triangle me-1"></i> {{ form.stock_critico.label }}
                            </label>
                            {{ form.stock_critico }}
                            <div class="form-text text-xs text-muted">{{ form.stock_critico.help_text }}</div>
                            {% if form.stock_critico.errors %}
                                <div class="text-danger text-xs mt-1">{{ form.stock_critico.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.proveedor_preferido.id_for_label }}" class="form-label font-bold text-sm color_primario_variante">{{ form.proveedor_preferido.label }}</label>
                            {# Wrapper para evitar saltos visuales antes de que cargue el JS #}
                            <div class="tom-select-wrapper">
                                {{ form.proveedor_preferido }}
                            </div>
                            {% if form.proveedor_preferido.errors %}
                                <div class="text-danger text-xs mt-1">{{ form.proveedor_preferido.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.costo_compra.id_for_label }}" class="form-label font-bold text-sm color_primario_variante">{{ form.costo_compra.label }}</label>
                             <div class="input-group input-group-sm">
                                 <span class="input-group-text text-base">$</span>
                                 {{ form.costo_compra }}
                             </div>
                            {% if form.costo_compra.errors %}
                                <div class="text-danger text-xs mt-1">{{ form.costo_compra.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.vida_util_estacion_anos.id_for_label }}" class="form-label font-bold text-sm color_primario_variante">Vida Útil (Años) - Regla Local</label>
                            {{ form.vida_util_estacion_anos }}
                            <div class="form-text text-xs text-muted">
                                Define la vida útil que usará tu estación. 
                                Si se deja en blanco, se usará la recomendación global ({{ producto.producto_global.vida_util_recomendada_anos|default:"N/A" }} años).
                            </div>
                            {% if form.vida_util_estacion_anos.errors %}
                                <div class="text-danger text-xs mt-1">{{ form.vida_util_estacion_anos.errors|striptags }}</div>
                            {% endif %}
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'gestion_inventario:ruta_catalogo_local' %}" class="btn btn-outline-secondary text-base">Cancelar</a>
                            
                            {# PERMISO: Gestionar Catálogo Local #}
                            {% if perms.gestion_usuarios.accion_gestion_inventario_gestionar_catalogo_local %}
                            <button type="submit" class="btn btn-primary text-base px-4">Guardar Cambios</button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* FIX para Tom Select: Asegurar que se vea integrado con Bootstrap */
    .ts-wrapper .ts-control {
        font-size: var(--font-base) !important;
        line-height: 1.5 !important;
        border-radius: 0.25rem; /* Coincidir con border-radius de BS sm */
        padding: 0.375rem 0.75rem;
    }
    .ts-dropdown .option {
        font-size: var(--font-base) !important;
    }
    .ts-control input {
        font-size: inherit !important;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // Configuración de TomSelect
        const tomSelectConfig = {
            create: false,
            sortField: { field: "text", direction: "asc" },
            placeholder: "Buscar proveedor...",
            allowEmptyOption: true,
        };

        // Inicializar todos los selects que tengan la clase 'tom-select-basic'
        document.querySelectorAll('.tom-select-basic').forEach(el => {
            if (!el.tomselect) {
                new TomSelect(el, tomSelectConfig);
            }
        });
    });
</script>
{% endblock %}