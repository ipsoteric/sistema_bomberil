{% extends 'gestion_inventario/layouts/base.html' %}
{% load static %}
{% load humanize %}

{% block titulo_ventana %}Hoja de Vida: {{ item.producto.producto_global.nombre_oficial }}{% endblock %}

{% block titulo_pagina %}
    <div class="d-flex justify-content-between align-items-center w-100">
        <div class="d-flex align-items-center">
            <a href="{% url 'gestion_inventario:ruta_stock_actual' %}" class="btn btn-light rounded-circle me-3 shadow-sm" title="Volver al Stock">
                <i class="fas fa-arrow-left text-muted"></i>
            </a>
            <div>
                <h4 class="mb-0 font-bold color_primario text-xl">Hoja de Vida</h4>
                <small class="text-muted text-sm">Detalle de Existencia</small>
            </div>
        </div>
        
        {# PERMISO: Imprimir Etiquetas #}
        {% if perms.gestion_usuarios.accion_gestion_inventario_imprimir_etiquetas_qr %}
        <div class="d-flex gap-2">
            {% if es_activo %}
                <a href="{% url 'gestion_inventario:ruta_imprimir_etiquetas' %}?activos={{ item.id }}" target="_blank" class="btn btn-outline-dark text-base shadow-sm">
                    <i class="fas fa-qrcode me-2"></i> Etiqueta
                </a>
            {% else %}
                <a href="{% url 'gestion_inventario:ruta_imprimir_etiquetas' %}?lotes={{ item.id }}" target="_blank" class="btn btn-outline-dark text-base shadow-sm">
                    <i class="fas fa-qrcode me-2"></i> Etiqueta
                </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">

    {# --- TARJETA PRINCIPAL: RESUMEN --- #}
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-4">
            <div class="row g-4">
                
                {# Columna 1: Imagen y Tipo #}
                <div class="col-md-2 text-center">
                    {% with img_activo=item.imagen_thumb_medium img_global=item.producto.producto_global.imagen_thumb_medium %}
                        {% if img_activo %}
                            <img src="{{ img_activo.url }}" class="img-fluid rounded shadow-sm border mb-3" style="max-height: 150px; width: 100%; object-fit: cover;">
                        {% elif img_global %}
                            <img src="{{ img_global.url }}" class="img-fluid rounded opacity-75 mb-3" style="max-height: 150px; width: 100%; object-fit: contain;">
                        {% else %}
                            <div class="bg-light rounded d-flex align-items-center justify-content-center text-muted border mb-3" style="height: 150px; width: 100%;">
                                <i class="fas fa-camera fs-1 opacity-25"></i>
                            </div>
                        {% endif %}
                    {% endwith %}
                    
                    <div>
                        {% if es_activo %}
                            <span class="badge bg-primary text-white text-xs w-100 py-2">ACTIVO SERIALIZADO</span>
                        {% else %}
                            <span class="badge bg-warning text-dark text-xs w-100 py-2">LOTE INSUMO</span>
                        {% endif %}
                    </div>
                </div>

                {# Columna 2: Datos Principales #}
                <div class="col-md-5 border-end">
                    <h3 class="font-bold color_primario mb-1 text-xl">{{ item.producto.producto_global.nombre_oficial }}</h3>
                    <p class="text-muted mb-4 text-base">{{ item.producto.producto_global.marca|default:"Genérico" }} {{ item.producto.producto_global.modelo|default:"" }}</p>
                    
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="text-xs text-muted font-bold text-uppercase d-block">Identificador</label>
                            <div class="text-lg font-monospace text-dark text-data-code font-bold">
                                {% if es_activo %}{{ item.codigo_activo }}{% else %}{{ item.codigo_lote }}{% endif %}
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="text-xs text-muted font-bold text-uppercase d-block">Estado Actual</label>
                            <div>
                                {% if item.estado.nombre == 'OPERATIVO' or item.estado.nombre == 'DISPONIBLE' %}
                                    <span class="badge bg-success text-xs"><i class="fas fa-check-circle me-1"></i> {{ item.estado.nombre }}</span>
                                {% elif item.estado.nombre == 'EN MANTENCIÓN' %}
                                    <span class="badge bg-warning text-dark text-xs"><i class="fas fa-tools me-1"></i> {{ item.estado.nombre }}</span>
                                {% else %}
                                    <span class="badge bg-secondary text-xs">{{ item.estado.nombre }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="text-xs text-muted font-bold text-uppercase d-block">Ubicación Actual</label>
                            <div class="text-base">
                                <i class="fas fa-map-marker-alt text-danger me-1"></i>
                                <span class="text-muted">{{ item.compartimento.ubicacion.nombre }}</span> <i class="fas fa-chevron-right mx-1 text-xs text-muted"></i> <strong>{{ item.compartimento.nombre }}</strong>
                            </div>
                        </div>
                    </div>
                </div>

                {# Columna 3: Estadísticas #}
                <div class="col-md-5 ps-md-4">
                    <h6 class="font-bold text-muted mb-3 text-xs text-uppercase">Estadísticas Rápidas</h6>
                    <div class="row g-3">
                        {% if es_activo %}
                            <div class="col-6">
                                <div class="p-3 bg-light rounded border text-center">
                                    <div class="text-xl font-bold color_primario">{{ uso_stats.total_horas|default:"0" }} h</div>
                                    <small class="text-muted text-xs">Uso Acumulado</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-light rounded border text-center">
                                    <div class="text-xl font-bold {% if item.vida_util_restante < 1 %}text-danger{% else %}text-success{% endif %}">
                                        {{ item.fin_vida_util|timeuntil }}
                                    </div>
                                    <small class="text-muted text-xs">Vida Útil Restante</small>
                                </div>
                            </div>
                        {% else %}
                            <div class="col-6">
                                <div class="p-3 bg-light rounded border text-center">
                                    <div class="text-xl font-bold color_primario">{{ item.cantidad }}</div>
                                    <small class="text-muted text-xs">Stock Actual</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-light rounded border text-center">
                                    <div class="text-xl font-bold text-dark">
                                        {{ item.fecha_recepcion|timesince }}
                                    </div>
                                    <small class="text-muted text-xs">Antigüedad en Bodega</small>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# --- PESTAÑAS DE DETALLE --- #}
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom-0 pt-3 px-4">
            <ul class="nav nav-tabs card-header-tabs" id="detalleTab" role="tablist">
                
                <li class="nav-item">
                    <button class="nav-link active font-bold text-sm" id="bitacora-tab" data-bs-toggle="tab" data-bs-target="#bitacora" type="button">
                        <i class="fas fa-history me-2"></i> Trazabilidad (Bitácora)
                    </button>
                </li>

                {% if es_activo %}
                <li class="nav-item">
                    <button class="nav-link font-bold text-sm" id="mantenimiento-tab" data-bs-toggle="tab" data-bs-target="#mantenimiento" type="button">
                        <i class="fas fa-tools me-2"></i> Mantenimiento
                        {% if ordenes_activas %}<span class="badge bg-danger rounded-pill ms-1 text-xs">{{ ordenes_activas.count }}</span>{% endif %}
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link font-bold text-sm" id="uso-tab" data-bs-toggle="tab" data-bs-target="#uso" type="button">
                        <i class="fas fa-stopwatch me-2"></i> Historial de Uso
                    </button>
                </li>
                {% endif %}

                <li class="nav-item">
                    <button class="nav-link font-bold text-sm" id="tecnica-tab" data-bs-toggle="tab" data-bs-target="#tecnica" type="button">
                        <i class="fas fa-info-circle me-2"></i> Ficha Técnica
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body p-4">
            <div class="tab-content" id="detalleTabContent">
                
                {# TAB 1: BITÁCORA (TRAZABILIDAD) #}
                <div class="tab-pane fade show active" id="bitacora" role="tabpanel">
                    
                    {% if perms.gestion_usuarios.accion_gestion_inventario_ver_historial_movimientos %}
                        <h6 class="mb-3 text-muted text-xs text-uppercase font-bold">Últimos 50 Movimientos Registrados</h6>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light text-xs font-bold text-uppercase text-muted">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Origen &rarr; Destino</th>
                                        <th>Usuario</th>
                                        <th>Notas</th>
                                    </tr>
                                </thead>
                                <tbody class="text-sm">
                                    {% for mov in historial_movimientos %}
                                    <tr>
                                        <td class="text-data-code text-xs">{{ mov.fecha_hora|date:"d/m/Y H:i" }}</td>
                                        <td>
                                            {% if mov.tipo_movimiento == 'ENT' %}<span class="badge bg-success text-xs">ENTRADA</span>
                                            {% elif mov.tipo_movimiento == 'SAL' %}<span class="badge bg-danger text-xs">SALIDA</span>
                                            {% elif mov.tipo_movimiento == 'TRA' %}<span class="badge bg-primary text-xs">TRASLADO</span>
                                            {% elif mov.tipo_movimiento == 'PRE' %}<span class="badge bg-warning text-dark text-xs">PRÉSTAMO</span>
                                            {% else %}<span class="badge bg-secondary text-xs">{{ mov.get_tipo_movimiento_display }}</span>{% endif %}
                                        </td>
                                        <td>
                                            <span class="fw-bold">{{ mov.compartimento_origen.nombre|default:"Externo" }}</span> 
                                            <i class="fas fa-arrow-right mx-2 text-muted text-xs"></i> 
                                            <span class="fw-bold">{{ mov.compartimento_destino.nombre|default:"Externo" }}</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="bg-light rounded-circle me-2 d-flex align-items-center justify-content-center" style="width:24px;height:24px;">
                                                    <i class="fas fa-user text-secondary text-xs"></i>
                                                </div>
                                                {{ mov.usuario.get_full_name }}
                                            </div>
                                        </td>
                                        <td class="text-muted fst-italic text-xs">{{ mov.notas|truncatechars:50 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="5" class="text-center py-4 text-muted text-sm">Sin movimientos registrados.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-light border text-center text-muted text-sm">
                            <i class="fas fa-lock me-2"></i> No tienes permiso para ver el historial de movimientos.
                        </div>
                    {% endif %}
                </div>

                {% if es_activo %}
                {# TAB 2: MANTENIMIENTO #}
                <div class="tab-pane fade" id="mantenimiento" role="tabpanel">
                    
                    {% if perms.gestion_usuarios.accion_gestion_mantenimiento_ver_ordenes %}
                        <div class="row g-4">
                            <div class="col-lg-4">
                                <h6 class="font-bold color_primario mb-3 text-sm text-uppercase">Planes de Mantenimiento Asignados</h6>
                                {% if planes_asociados %}
                                    <div class="list-group text-sm">
                                        {% for config in planes_asociados %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1 font-bold text-dark">{{ config.plan.nombre }}</h6>
                                                <small class="text-muted text-xs">{% if config.plan.tipo_trigger == 'TIEMPO' %}Cada {{ config.plan.intervalo }} {{ config.plan.frecuencia }}{% else %}Por Uso{% endif %}</small>
                                            </div>
                                            <p class="mb-1 text-xs text-muted">Última: {{ config.fecha_ultima_mantencion|date:"d/m/Y"|default:"Nunca" }}</p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-light border text-sm">No hay planes automáticos asignados.</div>
                                {% endif %}
                                
                                <hr class="my-4">
                                <h6 class="font-bold text-danger mb-2 text-sm text-uppercase">Órdenes Pendientes</h6>
                                {% if ordenes_activas %}
                                    {% for orden in ordenes_activas %}
                                        <div class="alert alert-warning d-flex justify-content-between align-items-center p-2">
                                            <span class="text-sm"><i class="fas fa-exclamation-circle me-2"></i> <strong>Orden #{{ orden.id }}</strong> <span class="text-xs">({{ orden.fecha_programada|date:"d/m/Y" }})</span></span>
                                            <a href="{% url 'gestion_mantenimiento:ruta_gestionar_orden' pk=orden.id %}" class="btn btn-sm btn-warning text-xs">Ver</a>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-success text-sm"><i class="fas fa-check me-1"></i> No hay mantenimientos pendientes.</p>
                                {% endif %}
                            </div>

                            <div class="col-lg-8 border-start">
                                <h6 class="font-bold color_primario mb-3 text-sm text-uppercase">Historial de Ejecuciones (Logbook)</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm text-sm">
                                        <thead class="text-xs text-muted text-uppercase">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Ejecutor</th>
                                                <th>Notas</th>
                                                <th class="text-center">Resultado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for log in historial_mantencion %}
                                            <tr>
                                                <td class="text-data-code">{{ log.fecha_ejecucion|date:"d/m/Y" }}</td>
                                                <td>{{ log.usuario_ejecutor.get_full_name }}</td>
                                                <td>{{ log.notas }}</td>
                                                <td class="text-center">
                                                    {% if log.fue_exitoso %}
                                                        <span class="badge bg-success text-xs"><i class="fas fa-check"></i> Éxito</span>
                                                    {% else %}
                                                        <span class="badge bg-danger text-xs"><i class="fas fa-times"></i> Falló</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr><td colspan="4" class="text-center text-muted py-4">Aún no se han realizado mantenciones.</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-light border text-center text-muted text-sm">
                            <i class="fas fa-lock me-2"></i> No tienes permiso para ver el historial de mantenimiento.
                        </div>
                    {% endif %}
                </div>

                {# TAB 3: USO #}
                <div class="tab-pane fade" id="uso" role="tabpanel">
                    <div class="row">
                        <div class="col-md-12">
                            <h6 class="mb-3 text-muted text-xs font-bold text-uppercase">Registro de horas de servicio</h6>
                            <table class="table table-striped table-sm text-sm">
                                <thead class="text-xs text-muted text-uppercase">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Registrado por</th>
                                        <th>Horas</th>
                                        <th>Notas</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for uso in ultimos_usos %}
                                    <tr>
                                        <td class="text-data-code">{{ uso.fecha_uso|date:"d/m/Y H:i" }}</td>
                                        <td>{{ uso.usuario_registra.get_full_name }}</td>
                                        <td class="font-bold">{{ uso.horas_registradas }} h</td>
                                        <td>{{ uso.notas|default:"-" }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="4" class="text-center text-muted py-4">Sin registros de uso.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {# TAB 4: FICHA TÉCNICA #}
                <div class="tab-pane fade" id="tecnica" role="tabpanel">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 font-bold text-primary text-sm text-uppercase">Datos de Adquisición</h6>
                            <dl class="row text-base">
                                <dt class="col-sm-4 text-muted text-sm">Fecha Recepción</dt>
                                <dd class="col-sm-8 text-data-code">{{ item.fecha_recepcion|date:"d/m/Y" }}</dd>

                                <dt class="col-sm-4 text-muted text-sm">Proveedor</dt>
                                <dd class="col-sm-8">{{ item.proveedor.nombre|default:"Desconocido" }}</dd>

                                <dt class="col-sm-4 text-muted text-sm">Costo Compra</dt>
                                <dd class="col-sm-8 text-data-code">${{ item.producto.costo_compra|intcomma|default:"0" }}</dd>

                                <dt class="col-sm-4 text-muted text-sm">Vida Útil Est.</dt>
                                <dd class="col-sm-8">{{ item.producto.vida_util_efectiva }} años</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 font-bold text-primary text-sm text-uppercase">Datos del Fabricante</h6>
                            <dl class="row text-base">
                                <dt class="col-sm-4 text-muted text-sm">Marca</dt>
                                <dd class="col-sm-8">{{ item.producto.producto_global.marca }}</dd>

                                <dt class="col-sm-4 text-muted text-sm">N° Serie / Lote</dt>
                                <dd class="col-sm-8 font-monospace text-data-code">
                                    {% if es_activo %}{{ item.numero_serie_fabricante }}{% else %}{{ item.numero_lote_fabricante }}{% endif %}
                                </dd>

                                <dt class="col-sm-4 text-muted text-sm">Fabricación</dt>
                                <dd class="col-sm-8 text-data-code">
                                    {% if es_activo %}{{ item.fecha_fabricacion|date:"d/m/Y"|default:"-" }}
                                    {% else %}-{% endif %}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>
{% endblock %}