{% extends 'gestion_inventario/layouts/base.html' %}
{% load static %}

{% block titulo_ventana %}Lista de Compartimentos{% endblock %}

{% block titulo_pagina %}
    <span class="text-xl color_primario">
        <i class="fas fa-boxes me-2"></i> Compartimentos
    </span>
{% endblock %}

{% block contenido %}

<div class="container-fluid mt-4">

    {# Panel de Filtros (Colapsable para limpieza visual) #}
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-white py-2 border-bottom-0">
            <a class="btn btn-link text-decoration-none text-dark font-bold text-base p-0 d-flex align-items-center" data-bs-toggle="collapse" href="#collapseFiltros" role="button" aria-expanded="true" aria-controls="collapseFiltros">
                <div class="bg-light rounded-circle p-2 me-2 d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                    <i class="fas fa-filter text-primary"></i>
                </div>
                Filtros de Búsqueda
                <i class="fas fa-chevron-down ms-2 text-xs text-muted"></i>
            </a>
        </div>
        
        <div class="collapse show" id="collapseFiltros">
            <div class="card-body pt-0 px-4 pb-4">
                <form id="filtros" method="get" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="ubicacion" class="form-label font-bold text-xs text-uppercase text-muted">Ubicación Padre</label>
                        <select name="ubicacion" id="ubicacion" class="form-select text-base">
                            <option value="">-- Todas --</option>
                            {% for s in ubicaciones %}
                            <option value="{{ s.id }}" {% if request.GET.ubicacion == s.id|stringformat:'s' %}selected{% endif %}>{{ s.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="nombre" class="form-label font-bold text-xs text-uppercase text-muted">Nombre contiene</label>
                        <input type="search" name="nombre" id="nombre" value="{{ request.GET.nombre|default:'' }}" class="form-control text-base" placeholder="Ej: Cajonera, Estante...">
                    </div>

                    <div class="col-md-2">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="descripcion_presente" value="1" id="descpres" {% if request.GET.descripcion_presente == '1' %}checked{% endif %}>
                            <label class="form-check-label text-sm" for="descpres">Con descripción</label>
                        </div>
                    </div>

                    <div class="col-md-2 d-flex gap-2">
                        <button type="submit" class="btn btn-primary w-100 text-base">Filtrar</button>
                        <a href="{% url 'gestion_inventario:ruta_lista_compartimentos' %}" class="btn btn-outline-secondary w-100 text-base">Limpiar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {# Tabla de Resultados #}
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-white border-bottom py-3">
            <span class="font-bold text-lg color_primario">
                <i class="fas fa-list-ul me-1"></i>
                Lista de Compartimentos
            </span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary text-uppercase text-xs font-bold">
                        <tr>
                            <th class="ps-4 py-3">Ubicación (Padre)</th>
                            <th>Compartimento</th>
                            <th>Descripción</th>
                            <th class="text-end pe-4">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="text-base">
                        {% for c in compartimentos %}
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    {# Icono dinámico según tipo de ubicación padre #}
                                    <div class="me-2 text-muted" style="width: 20px; text-align: center;">
                                        {% if c.ubicacion.tipo_ubicacion.nombre == 'VEHÍCULO' %}
                                            <i class="fas fa-truck text-xs"></i>
                                        {% else %}
                                            <i class="fas fa-warehouse text-xs"></i>
                                        {% endif %}
                                    </div>
                                    <a href="{% url 'gestion_inventario:ruta_gestionar_ubicacion' c.ubicacion.id %}" class="text-decoration-none text-dark font-bold text-sm hover-primary">
                                        {{ c.ubicacion.nombre }}
                                    </a>
                                </div>
                            </td>
                            
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-level-up-alt fa-rotate-90 text-muted me-2 ms-1 opacity-25"></i>
                                    <strong class="text-primary">{{ c.nombre }}</strong>
                                </div>
                            </td>
                            
                            <td class="text-sm text-muted text-truncate" style="max-width: 250px;">
                                {{ c.descripcion|default:'-' }}
                            </td>
                            
                            <td class="text-end pe-4">
                                <div class="btn-group">
                                    {# PERMISO: Ver Stock (Ver detalle) #}
                                    {% if perms.gestion_usuarios.accion_gestion_inventario_ver_stock %}
                                    <a class="btn btn-sm btn-outline-primary text-xs" 
                                       href="{% url 'gestion_inventario:ruta_detalle_compartimento' compartimento_id=c.id %}"
                                       title="Ver Contenido">
                                        Ver
                                    </a>
                                    {% endif %}
                                    
                                    {# PERMISO: Gestionar Ubicaciones (Editar/Eliminar) #}
                                    {% if perms.gestion_usuarios.accion_gestion_inventario_gestionar_ubicaciones %}
                                    <a class="btn btn-sm btn-outline-secondary text-xs" 
                                       href="{% url 'gestion_inventario:ruta_editar_compartimento' compartimento_id=c.id %}"
                                       title="Editar">
                                        <i class="fas fa-pen"></i>
                                    </a>
                                    <a class="btn btn-sm btn-outline-danger text-xs" 
                                       href="{% url 'gestion_inventario:ruta_eliminar_compartimento' compartimento_id=c.id %}"
                                       title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-5">
                                <div class="text-muted opacity-50">
                                    <i class="fas fa-box-open fa-3x mb-3"></i>
                                    <h5 class="text-lg">No se encontraron compartimentos</h5>
                                    <p class="text-sm">Intenta ajustar los filtros de búsqueda.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<style>
    .hover-primary:hover {
        color: var(--color-primario) !important;
        text-decoration: underline !important;
    }
</style>

{% endblock %}