{% extends 'gestion_inventario/layouts/base.html' %}
{% load static %}

{% block titulo_ventana %}Crear Préstamo Externo{% endblock %}

{% block titulo_pagina %}
    <span class="fs_grande color_primario">
        <i class="fas fa-hand-holding-medical me-2"></i> Registrar Préstamo Externo
    </span>
{% endblock %}

{% block extrastyles %}
<style>
    /* Estilos para la tabla de escaneo */
    #scan-input {
        font-size: 1.25rem;
        text-align: center;
    }
    .scan-feedback {
        height: 20px;
        font-size: var(--fs-normal);
    }
    #items-prestados-table .btn-quitar {
        font-size: var(--fs-pequena);
    }
    #items-prestados-table .item-info {
        font-size: var(--fs-normal);
    }
    #items-prestados-table .item-code {
        font-size: var(--fs-pequena);
        font-family: monospace;
    }
</style>
{% endblock %}


{% block contenido %}
<div class="container-fluid mt-4">

<form method="post" id="prestamo-form" novalidate>
    {% csrf_token %}
    
    <!-- Input oculto que mantendrá la lista de ítems -->
    <input type="hidden" name="items_json" id="items-json-input" value="{{ items_json_error|default:'[]' }}">

    <!-- Panel 1: Datos Generales -->
    <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold fs_mediana">
            <i class="fas fa-user-friends me-1"></i> Paso 1: Datos del Préstamo
        </div>
        <div class="card-body p-4">
            <!-- (Formulario de Cabecera igual que antes) -->
            <div class="row g-3">
                <div class="col-md-5">
                    <label for="{{ cabecera_form.destinatario.id_for_label }}" class="form-label fw-bold fs_pequena">Destinatario (Ej: Clínica, Hospital)</label>
                    {{ cabecera_form.destinatario }}
                    {% if cabecera_form.destinatario.errors %}<div class="invalid-feedback d-block">{{ cabecera_form.destinatario.errors.0 }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label for="{{ cabecera_form.fecha_devolucion_esperada.id_for_label }}" class="form-label fw-bold fs_pequena">Fecha Devolución Esperada</label>
                    {{ cabecera_form.fecha_devolucion_esperada }}
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-5">
                    <label for="{{ cabecera_form.nuevo_destinatario_nombre.id_for_label }}" class="form-label fw-bold fs_pequena">{{ cabecera_form.nuevo_destinatario_nombre.label }}</label>
                    {{ cabecera_form.nuevo_destinatario_nombre }}
                    {% if cabecera_form.nuevo_destinatario_nombre.errors %}<div class="invalid-feedback d-block">{{ cabecera_form.nuevo_destinatario_nombre.errors.0 }}</div>{% endif %}
                </div>
                <div class="col-md-4">
                    <label for="{{ cabecera_form.nuevo_destinatario_contacto.id_for_label }}" class="form-label fw-bold fs_pequena">{{ cabecera_form.nuevo_destinatario_contacto.label }}</label>
                    {{ cabecera_form.nuevo_destinatario_contacto }}
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-9">
                    <label for="{{ cabecera_form.notas_prestamo.id_for_label }}" class="form-label fw-bold fs_pequena">Notas / Motivo</label>
                    {{ cabecera_form.notas_prestamo }}
                </div>
            </div>
            {% if cabecera_form.non_field_errors %}
                <div class="alert alert-danger mt-3 color_blanco">
                    {% for error in cabecera_form.non_field_errors %}
                        {{ error }}<br>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Panel 2: Escaneo de Ítems -->
    <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold fs_mediana">
            <i class="fas fa-qrcode me-1"></i> Paso 2: Escanear Ítems a Prestar
        </div>
        <div class="card-body p-4">
            
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <label for="scan-select" class="form-label fw-bold fs_pequena">Buscar o Escanear Ítem</label>

                    <select id="scan-select" class="form-control" placeholder="Escriba código o nombre del producto...">
                    </select>

                    <div class="scan-feedback mt-1">
                        <span id="scan-feedback-text" class="text-danger"></span>
                    </div>

                    <div class="form-text fs_pequena text-muted">
                        <i class="fas fa-info-circle"></i> Puede escanear con la pistola o escribir para buscar manualmente.
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <h5 class="fs_normal fw-bold color_primario">Ítems Agregados (<span id="item-count">0</span>)</h5>
            <div class="table-responsive">
                <table class="table align-middle" id="items-prestados-table">
                    <thead class="fs_pequena">
                        <tr>
                            <th>Producto</th>
                            <th>Código</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-end">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Las filas se agregarán aquí con JS -->
                        <tr id="no-items-row">
                            <td colspan="4" class="text-center fst-italic text-muted">Aún no se han escaneado ítems.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Botón de guardado -->
            <div class="d-flex justify-content-end mt-4 pt-4 border-top">
                <a href="{% url 'gestion_inventario:ruta_stock_actual' %}" class="btn btn-secondary fs_normal me-2">Cancelar</a>
                <button type="submit" class="btn btn-primary fs_normal">
                    <i class="fas fa-save me-1"></i> Finalizar y Guardar Préstamo
                </button>
            </div>
            
        </div>
    </div>
</form>

</div> <!-- Cierre de container-fluid -->
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. Selectores del DOM ---
    const feedbackText = document.getElementById('scan-feedback-text');
    const itemsTableBody = document.querySelector('#items-prestados-table tbody');
    const noItemsRow = document.getElementById('no-items-row');
    const itemCountSpan = document.getElementById('item-count');
    const hiddenJsonInput = document.getElementById('items-json-input');
    const prestamoForm = document.getElementById('prestamo-form');
    const scanSelectEl = document.getElementById('scan-select');

    // URL de la API de búsqueda
    const apiUrl = "{% url 'api:api_buscar_prestables' %}";

    // --- 2. Configuración de TomSelect (Buscador Inteligente) ---
    const tsScan = new TomSelect(scanSelectEl, {
        valueField: 'id',
        labelField: 'texto_mostrar',
        searchField: ['nombre', 'codigo'],
        placeholder: "Escriba código o nombre...",
        maxItems: 1,
        load: function(query, callback) {
            if (!query.length) return callback();
            
            fetch(apiUrl + '?q=' + encodeURIComponent(query))
                .then(response => response.json())
                .then(json => {
                    callback(json.items);
                }).catch(() => {
                    callback();
                });
        },
        onChange: function(value) {
            if (!value) return;
            
            // Recuperar datos y procesar
            const itemData = this.options[value];
            const itemProcesado = {
                id: itemData.real_id,
                tipo: itemData.tipo,
                codigo: itemData.codigo,
                nombre: itemData.nombre,
                max_qty: itemData.max_qty
            };

            addItem(itemProcesado);

            // Limpiar y re-enfocar
            this.clear(); 
            this.clearOptions();
            this.control_input.focus(); 
        },
        render: {
            option: function(item, escape) {
                const colorClass = item.tipo === 'activo' ? 'text-primary' : 'text-success';
                const icon = item.tipo === 'activo' ? 'fa-barcode' : 'fa-boxes';
                return `<div class="py-2 d-flex align-items-center">
                            <i class="fas ${icon} ${colorClass} me-2 fs-4"></i>
                            <div>
                                <div class="fw-bold">${escape(item.nombre)}</div>
                                <div class="small text-muted">Cód: ${escape(item.codigo)}</div>
                            </div>
                        </div>`;
            }
        }
    });

    // --- 3. Estado de la Aplicación ---
    let itemsPrestados = [];
    try {
        itemsPrestados = JSON.parse(hiddenJsonInput.value || '[]');
    } catch (e) {
        console.error("Error al parsear JSON inicial", e);
        itemsPrestados = [];
    }

    // --- 4. Funciones de Lógica ---

    function showFeedback(message, isError = false) {
        feedbackText.textContent = message;
        feedbackText.className = isError ? 'text-danger' : 'text-success';
        setTimeout(() => {
            if (feedbackText.textContent === message) feedbackText.textContent = '';
        }, 3000);
    }

    function renderTabla() {
        itemsTableBody.innerHTML = ''; 
        
        if (itemsPrestados.length === 0) {
            itemsTableBody.appendChild(noItemsRow);
        } else {
            itemsPrestados.forEach((item, index) => {
                const tr = document.createElement('tr');
                const cantidad = item.tipo === 'activo' ? 1 : item.cantidad_prestada;
                
                tr.innerHTML = `
                    <td class="item-info">${item.nombre}</td>
                    <td class="item-code">${item.codigo}</td>
                    <td class="text-center item-info">${cantidad}</td>
                    <td class="text-end">
                        <button type="button" class="btn btn-danger btn-sm btn-quitar fs_pequena" data-index="${index}">
                            Quitar
                        </button>
                    </td>
                `;
                itemsTableBody.appendChild(tr);
            });
        }
        itemCountSpan.textContent = itemsPrestados.length;
    }

    function actualizarInputOculto() {
        hiddenJsonInput.value = JSON.stringify(itemsPrestados);
    }

    function addItem(itemData) {
        // Validar duplicados
        const esDuplicado = itemsPrestados.some(item => 
            item.tipo === itemData.tipo && item.id === itemData.id
        );
        if (esDuplicado) {
            showFeedback(`El ítem ${itemData.codigo} ya está en la lista.`, true);
            return;
        }
        
        // Lógica de Lotes (Pedir cantidad)
        if (itemData.tipo === 'lote') {
            const qty = prompt(`Ítem: ${itemData.nombre}\nDisp: ${itemData.max_qty}\n\nIngrese cantidad a prestar:`, 1);
            const cantidadPrestada = parseInt(qty, 10);
            
            if (isNaN(cantidadPrestada) || cantidadPrestada <= 0) {
                return; // Cancelado por el usuario
            }
            if (cantidadPrestada > itemData.max_qty) {
                showFeedback(`Error: Solo hay ${itemData.max_qty} unidades disponibles.`, true);
                return;
            }
            itemData.cantidad_prestada = cantidadPrestada;
        }

        itemsPrestados.push(itemData);
        renderTabla();
        actualizarInputOculto();
        showFeedback(`Agregado: ${itemData.nombre}`, false);
    }

    // --- 5. Manejadores de Eventos ---

    // Eliminar ítem de la tabla
    itemsTableBody.addEventListener('click', function(e) {
        if (!e.target.classList.contains('btn-quitar')) return;
        
        e.preventDefault();
        const index = parseInt(e.target.dataset.index, 10);
        
        if (!isNaN(index)) {
            const itemRemovido = itemsPrestados.splice(index, 1)[0];
            renderTabla();
            actualizarInputOculto();
            showFeedback(`Quitado: ${itemRemovido.nombre}`, false);
            
            // CORRECCIÓN: Enfocar el TomSelect en lugar del input viejo
            tsScan.control_input.focus(); 
        }
    });

    // Validación al enviar el formulario
    prestamoForm.addEventListener('submit', (e) => {
        if (itemsPrestados.length === 0) {
            e.preventDefault();
            showFeedback("Debe agregar al menos un ítem para guardar.", true);
            tsScan.control_input.focus();
        }
    });

    // Inicializar TomSelects de destinatarios
    document.querySelectorAll('.tom-select-basic').forEach(el => {
        if (!el.tomselect) new TomSelect(el, { create: false, placeholder: "Seleccionar..."});
    });

    // Render inicial por si hay datos de error
    if (itemsPrestados.length > 0) {
        renderTabla();
    }
});
</script>
{% endblock %}