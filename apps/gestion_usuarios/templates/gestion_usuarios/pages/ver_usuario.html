{# Plantilla base #}{% extends 'gestion_usuarios/layouts/base.html' %}
{# Cargar assets #}{% load static %}
{# Cargar filtros #}{% load age_filters %}{% load humanize %}
{# Título de la ventana #} {% block titulo_ventana %} {{membresia.usuario.get_full_name|title}} {% endblock %}
{# Título de la página #} {% block titulo_pagina %} Información de usuario {% endblock %}

{% block contenido %}

<div class="caja_para_pagina_contenido_arriba">
    <div class="usuarios_ver_usuario__cuadricula panel_base fondo_secundario_variante">




        {# Avatar de usuario #}
        <section class="usuarios_ver_usuario__avatar">

            {# Avatar #}
            {% if membresia.usuario.avatar %}
            <img id="avatarUsuario" src="{{membresia.usuario.avatar.url|default:'static/imagenes/default_avatar.png'}}" alt="">
            {% else %}
            <img id="avatarUsuario" src="{% static 'imagenes/default_avatar.png' %}" alt="">
            {% endif %}

            {# Cambiar avatar #}
            <span id="botonSubirAvatarUsuario" class="usuarios_ver_usuario__edit_avatar_icon fondo_secundario color_primario fs_grande">
                <i class="fa-solid fa-pen-to-square"></i>
            </span>
            <input type="file" id="inputSubirAvatarUsuario" hidden accept="image/*">
        </section>




        {# Descripción de usuario #}
        <section class="usuarios_ver_usuario__descripcion">

            {# Nombre completo #}
            <h2 class="fs_x_grande color_primario">{{membresia.usuario.get_full_name|title}}</h2>
            <span class="fs_pequena color_primario_variante">Miembro de la {{membresia.estacion.nombre|title}}</span>


            {# Estado #}
            <div class="descripcion__estados fs_pequena">

                {% if membresia.usuario.is_superuser  %}
                <span class="descripcion__estado fondo_primario color_secundario etiqueta">Administrador</span>
                {% endif %}

                {% if membresia.usuario.is_staff %}
                <span class="descripcion__estado fondo_naranjo color_blanco etiqueta">Staff</span>
                {% endif %}

                {% if membresia.estado == 'ACTIVO' %}
                <span class="descripcion__estado fondo_verde color_blanco etiqueta">Activo</span>
                {% elif membresia.estado == 'INACTIVO' %}
                <span class="descripcion__estado fondo_gris_oscuro color_blanco etiqueta">Inactivo</span>
                {% endif %}

                {% if membresia.usuario.is_verified %}
                <span class="descripcion__estado fondo_azul color_blanco etiqueta">Verificado</span>
                {% endif %}
            </div>


            {# Roles del usuario #}
            <div class="descripcion__roles fs_pequena color_primario">
                Roles:
                {% for rol in membresia.roles.all %}
                <a href="{% url 'gestion_usuarios:ruta_ver_rol' id=rol.id %}" class="descripcion__rol color_azul">{{rol.nombre|title}}</a>
                {% empty %}
                <span class="descripcion__rol color_primario">Ninguno</span>
                {% endfor %}
            </div>

            {# Información adicional (PENDIENTE DE MODIFICAR) #}
            <div class="descripcion__informacion_adicional fs_normal">
                <a class="boton fondo_gris_oscuro color_blanco">Ver Permisos</a>
                <a class="boton fondo_morado color_blanco">Hoja de vida</a>
                <a class="boton fondo_morado color_blanco">Ficha médica</a>
            </div>

        </section>


        {# Acciones #}
        <section class="usuarios_ver_usuario__acciones">
            <a class="boton_flex fondo_azul color_blanco fs_normal" href="{% url 'gestion_usuarios:ruta_editar_usuario' id=membresia.usuario.id %}">Modificar información</a>
            <a class="boton_flex fondo_azul color_blanco fs_normal" href="{% url 'gestion_usuarios:ruta_asignar_roles_usuario' id=membresia.usuario.id %}">Asignar roles</a>
            {% if membresia.estado == 'ACTIVO' %}
            <a class="boton_flex fondo_rojo color_blanco fs_normal" href="{% url 'gestion_usuarios:ruta_desactivar_usuario' id=membresia.usuario.id %}">
                <i class="fa-solid fa-ban"></i>
                Desactivar
            </a>
            {% elif membresia.estado == 'INACTIVO' %}
            <a class="boton_flex fondo_azul color_blanco fs_normal" href="{% url 'gestion_usuarios:ruta_activar_usuario' id=membresia.usuario.id %}">
                <i class="fa-solid fa-circle-up"></i>
                Activar
            </a>
            {% endif %}
            <a class="boton_flex fondo_rojo color_blanco fs_normal" href="">
                <i class="fa-solid fa-flag-checkered"></i>
                Finalizar membresía
            </a>
        </section>


        {# Información del usuario #}
        <section class="usuarios_ver_usuario__informacion">
        <div class="informacion__seccion">
            <div class="informacion__campo fs_normal">
                <span class="informacion__label color_primario_variante">Correo electrónico:</span>
                {% if membresia.usuario.email %}
                <span class="color_primario">{{membresia.usuario.email}}</span>
                {% else %}
                <span class="color_primario">No especificado</span>
                {% endif %}
            </div>
            
            <div class="informacion__campo fs_normal">
                <span class="informacion__label color_primario_variante">RUT:</span>
                {% if membresia.usuario.rut %}
                <span class="color_primario">{{membresia.usuario.rut}}</span>
                {% else %}
                <span class="color_primario">No especificado</span>
                {% endif %}
            </div>
            
            <div class="informacion__campo fs_normal">
                <span class="informacion__label color_primario_variante">Edad:</span>
                {% if membresia.usuario.birthdate %}
                <span class="color_primario">{{membresia.usuario.birthdate|calculate_age}} años</span>
                {% else %}
                <span class="color_primario">No especificado</span>
                {% endif %}
            </div>
            
            <div class="informacion__campo fs_normal">
                <span class="informacion__label color_primario_variante">Teléfono:</span>
                {% if membresia.usuario.phone %}
                <span class="color_primario">{{membresia.usuario.phone}}</span>
                {% else %}
                <span class="color_primario">No especificado</span>
                {% endif %}
            </div>
        </div>
            
        <div class="informacion__seccion">
            <div class="informacion__campo fs_normal">
                <span class="informacion__label color_primario_variante">Creado:</span>
                <span class="color_primario">{{membresia.usuario.created_at|naturalday}}</span>
            </div>
            
            <div class="informacion__campo fs_normal">
                <span class="informacion__label color_primario_variante">Actualizado:</span>
                <span class="color_primario">{{membresia.usuario.updated_at|naturalday }}</span>
            </div>
            
            <div class="informacion__campo fs_normal">
                <span class="informacion__label color_primario_variante">Ingreso a la compañía:</span>
                <span class="color_primario">{{membresia.fecha_inicio|naturalday}}</span>
            </div>
        </div>
        </section>

    </div>
</div>






<script>
document.addEventListener('DOMContentLoaded', () => {
    const botonSubirAvatarUsuario = document.getElementById('botonSubirAvatarUsuario');
    const inputSubirAvatarUsuario = document.getElementById('inputSubirAvatarUsuario');
    const avatarUsuario = document.getElementById('avatarUsuario');
    
    // 1. Cuando se hace clic en el ícono de editar...
    botonSubirAvatarUsuario.addEventListener('click', () => {
        // ...hacemos clic programáticamente en el input oculto.
        inputSubirAvatarUsuario.click();
    });

    // 2. Cuando el usuario selecciona un archivo en el input...
    inputSubirAvatarUsuario.addEventListener('change', () => {
        const file = inputSubirAvatarUsuario.files[0];
        if (!file) {
            return; // No se seleccionó archivo
        }

        // 3. Preparamos los datos para enviarlos con AJAX
        const formData = new FormData();
        formData.append('nuevo_avatar', file);

        // Obtenemos el token CSRF para la seguridad de Django
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // 4. Enviamos el archivo al servidor
        fetch("{% url 'api:ruta_editar_avatar_usuario' id=membresia.usuario.id %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 5. Si todo fue bien, actualizamos la imagen en la página
                // Añadimos un timestamp para evitar problemas de caché del navegador
                avatarUsuario.src = data.new_avatar_url + '?' + new Date().getTime();
            } else {
                alert('Hubo un error al subir la imagen.');
                console.error(data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>

{% endblock  %}