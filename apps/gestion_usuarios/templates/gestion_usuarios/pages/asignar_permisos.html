{# Plantilla base #}{% extends 'gestion_usuarios/layouts/base.html' %}
{# Cargar assets #}{% load static %}
{# Cargar filtros #}{% load age_filters %}{% load humanize %}
{# Título de la ventana #} {% block titulo_ventana %}{{rol.nombre|title}} - Asignar permisos{% endblock %}
{# Título de la página #} {% block titulo_pagina %}Asignar permisos{% endblock %}

{% block contenido %}

<div class="caja_para_pagina_contenido_arriba">

<div class="container mt-4">
    <h1 class="color_primario">Asignar Permisos al Rol: <strong>{{ rol.nombre|title }}</strong></h1>
    <p class="color_primario_variante fs_normal">Gestiona los permisos aplicables a la estación <strong>{{ rol.estacion.nombre }}</strong>.</p>

    <form method="post">
        {% csrf_token %}

{% for app_label, data in permissions_by_app.items %}
<div class="card mb-4 fondo_secundario color_primario fs_normal">
    <div class="card-header">
        <div class="form-check">
            {# El checkbox "maestro" ahora es un permiso REAL #}
            {% if data.main_perm %}
                <input class="form-check-input check-all-module permiso-check" 
                       type="checkbox" 
                       name="permisos"
                       value="{{ data.main_perm.id }}"
                       id="module-{{ app_label }}" {# Usamos app_label #}
                       data-module="{{ app_label }}" {# Usamos app_label #}
                       {% if data.main_perm.id in rol_permissions_ids %}checked{% endif %}>
                <label class="form-check-label h5 fs_mediana" for="module-{{ app_label }}">
                    {{ data.verbose_name }} {# Mostramos el nombre legible #}
                </label>
            {% else %}
                <h5 class="fs_mediana">{{ data.verbose_name }}</h5>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            {# Iteramos solo sobre los permisos "hijos" #}
            {% for perm in data.children %}
            <div class="col-md-4 mb-2">
                <div class="form-check">
                    <input class="form-check-input permiso-check" 
                           type="checkbox" 
                           name="permisos" 
                           value="{{ perm.id }}" 
                           id="perm-{{ perm.id }}"
                           data-module="{{ app_label }}" {# Usamos app_label consistente #}
                           {% if perm.id in rol_permissions_ids %}checked{% endif %}>
                    <label class="form-check-label" for="perm-{{ perm.id }}">
                        {{ perm.name }}
                    </label>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endfor %}

        <div class="d-flex justify-content-end mb-5">
            <a href="{% url 'gestion_usuarios:ruta_lista_roles' %}" class="boton_s fs_normal color_primario_variante">Cancelar</a>
            <button type="submit" class="boton_s fondo_verde fs_normal color_blanco">Guardar Permisos</button>
        </div>
    </form>
</div>

</div>

{# Manejo de selección de permisos #}
<script>
document.addEventListener('DOMContentLoaded', function () {
    
    const moduleChecks = document.querySelectorAll('.check-all-module');
    const childChecks = document.querySelectorAll('.permiso-check:not(.check-all-module)');

    /**
     * Actualiza el estado visual del checkbox "padre" (marcado, desmarcado o indeterminado)
     * basándose en el estado de sus "hijos".
     */
    function updateParentState(moduleName) {
        const parentCheck = document.querySelector(`.check-all-module[data-module="${moduleName}"]`);
        if (!parentCheck) return;

        const children = document.querySelectorAll(`.permiso-check[data-module="${moduleName}"]:not(.check-all-module)`);
        const totalChildren = children.length;
        const checkedChildren = document.querySelectorAll(`.permiso-check[data-module="${moduleName}"]:not(.check-all-module):checked`).length;
        
        if (totalChildren === 0) return;

        if (checkedChildren === 0) {
            // Si no hay ningún hijo marcado, el padre no debe estar indeterminado.
            // OJO: No lo desmarcamos automáticamente, ya que el acceso es un permiso propio.
            parentCheck.indeterminate = false;
        } else if (checkedChildren === totalChildren) {
            // Si TODOS los hijos están marcados, el padre debe estar marcado y no indeterminado.
            parentCheck.checked = true;
            parentCheck.indeterminate = false;
        } else {
            // Si algunos hijos están marcados, el padre debe estar en estado indeterminado.
            parentCheck.indeterminate = true;
        }
    }

    // --- LÓGICA PARA LOS CHECKBOXES PADRE (MÓDULOS) ---
    moduleChecks.forEach(function (check) {
        check.addEventListener('change', function () {
            const moduleName = this.dataset.module;
            const children = document.querySelectorAll(`.permiso-check[data-module="${moduleName}"]:not(.check-all-module)`);
            
            // Regla 2 y 3: Marcar/desmarcar el padre afecta a todos los hijos.
            children.forEach(child => child.checked = this.checked);
        });
    });

    // --- LÓGICA PARA LOS CHECKBOXES HIJO (PERMISOS ESPECÍFICOS) ---
    childChecks.forEach(function (check) {
        check.addEventListener('change', function () {
            const moduleName = this.dataset.module;
            const parentCheck = document.querySelector(`.check-all-module[data-module="${moduleName}"]`);

            // Regla 1: Si se marca un hijo, el padre DEBE estar marcado.
            if (this.checked && parentCheck) {
                parentCheck.checked = true;
            }
            
            // Actualiza el estado visual del padre (indeterminado, etc.)
            updateParentState(moduleName);
        });
    });

    // --- ESTADO INICIAL AL CARGAR LA PÁGINA ---
    // Asegura que los checkboxes padre reflejen el estado de sus hijos al cargar la página.
    moduleChecks.forEach(function (check) {
        const moduleName = check.dataset.module;
        updateParentState(moduleName);
    });

});
</script>

{% endblock  %}